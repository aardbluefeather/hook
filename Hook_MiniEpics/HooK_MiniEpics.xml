<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<muclient>
<plugin
   name="HooK_MiniEpics"
   author="BlueFeather"
   id="2a0221da142c2505699c5adb"
   language="Lua"
   purpose="Mini epic (Titan/Terra) triggers and reports"
   save_state="y"
   date_written="2019-06-26 21:47:01"
   requires="5.06"
   version="0.2"
   >
<description trim="y">
<![CDATA[
A collection of triggers for use in Titan and Terra miniepics - to make life there easier.
]]>
</description>

</plugin>


<!--  Get our standard constants -->

<include name="constants.lua"/>

<!--  Triggers  -->

<triggers>
  <!-- Boss hits -->
  <trigger match="^(.+) looks very uncomfortable\.$"                               regexp="y" enabled="n" group="me_bhits" sequence="99" send_to="12"><send>hit_warning("%1",'y','Curse')</send></trigger>
  <trigger match="^You ridicule (.+) about \w+ childhood\.$"                       regexp="y" enabled="n" group="me_bhits" sequence="99" send_to="12"><send>hit_warning("%1",'n','Ego Whip')</send></trigger>
  <trigger match="^(.+?)'?s? ego is crushed by \w+!$"                              regexp="y" enabled="n" group="me_bhits" sequence="99" send_to="12"><send>hit_warning("%1",'n','Ego Whip')</send></trigger>
  <trigger match="^(.+) looks very ill\.$"                                         regexp="y" enabled="n" group="me_bhits" sequence="99" send_to="12"><send>hit_warning("%1",'n','Poison')</send></trigger>
  <trigger match="^You mark (.+) with a Rune of IX!$"                              regexp="y" enabled="n" group="me_bhits" sequence="99" send_to="12"><send>hit_warning("%1",'y','Rune of IX')</send></trigger>
  <trigger match="^(.+?)'?s? armor softens\.$"                                     regexp="y" enabled="n" group="me_bhits" sequence="99" send_to="12"><send>hit_warning("%1",'n','Soften')</send></trigger>
  <trigger match="^(.+) looks tired and weak\.$"                                   regexp="y" enabled="n" group="me_bhits" sequence="99" send_to="12"><send>hit_warning("%1",'n','Weaken')</send></trigger>
  <trigger match="^(.+) looks unwell\.$"                                           regexp="y" enabled="n" group="me_bhits" sequence="99" send_to="12"><send>hit_warning("%1",'n','Disease')</send></trigger>
  <trigger match="^(.+?)'?s? flesh is ripped from \w+ body\.$"                     regexp="y" enabled="n" group="me_bhits" sequence="99" send_to="12"><send>hit_warning("%1",'n','Raw Flesh')</send></trigger>
  <trigger match="^(.+) looks unwell\.$"                                           regexp="y" enabled="n" group="me_bhits" sequence="99" send_to="12"><send>hit_warning("%1",'n','Disease')</send></trigger>
  <trigger match="^(.+) appears to falter. Your victim is in serious trouble!$"    regexp="y" enabled="n" group="me_bhits" sequence="99" send_to="12"><send>hit_warning("%1",'n','Hydra Blood')</send></trigger>
  <trigger match="^(.+) appears pale and weak\.$"                                  regexp="y" enabled="n" group="me_bhits" sequence="99" send_to="12"><send>hit_warning("%1",'n','Hydra Blood')</send></trigger>
  <trigger match="^Your acidic venom burns away (.+?)'?s? armor\.$"                regexp="y" enabled="n" group="me_bhits" sequence="99" send_to="12"><send>hit_warning("%1",'n','Raven Scourge')</send></trigger>
  <trigger match="^(.+) appears much weaker and extremely vulnerable\.$"           regexp="y" enabled="n" group="me_bhits" sequence="99" send_to="12"><send>hit_warning("%1",'n','Green Death')</send></trigger>
  <trigger match="^(.+) appears extremely vulnerable as the mist surrounds \w+\.$" regexp="y" enabled="n" group="me_bhits" sequence="99" send_to="12"><send>hit_warning("%1",'n','Green Death')</send></trigger>
  <trigger match="^(.+) turns pale and appears weakened\.$"                        regexp="y" enabled="n" group="me_bhits" sequence="99" send_to="12"><send>hit_warning("%1",'y','Kobold Spray')</send></trigger>
  <trigger match="^(.+?)'?s? body starts to weaken\.$"                             regexp="y" enabled="n" group="me_bhits" sequence="99" send_to="12"><send>hit_warning("%1",'n','Hex of Entropy')</send></trigger>
  <!-- TITAN -->
  <!-- Boss start and boss end -->
  <trigger match="^Gjaka gives Gjaka's Burden to (.+)\.$" regexp="y" enabled="n" group="me_titan" sequence="99" send_to="12"><send>end_boss('titan','Gjaka',"%1")</send></trigger>
  <trigger match="^Grakkr gives Grakkr's Leadership to (.+)\.$" regexp="y" enabled="n" group="me_titan" sequence="99" send_to="12"><send>end_boss('titan','Grakkr',"%1")</send></trigger>
  <trigger match="^Morgak gives Morgak's Silence to (.+)\.$" regexp="y" enabled="n" group="me_titan" sequence="99" send_to="12"><send>end_boss('titan','Morgak',"%1")</send></trigger>
  <trigger match="^Orzbuk's .+ gives Orzbuk's Vision to (.+)\.$" regexp="y" enabled="n" group="me_titan" sequence="99" send_to="12"><send>end_boss('titan','Orzbuk',"%1")</send></trigger>
  <trigger match="^Lugthurg gives Lugthurg's Bones to (.+)\.$" regexp="y" enabled="n" group="me_titan" sequence="99" send_to="12"><send>end_boss('titan','Lugthurg',"%1")</send></trigger>
  <trigger match="^Once the Titan General is slain, Salkin quickly leads you back to the secret junction\.$" regexp="y" enabled="n" group="me_titan" sequence="99" send_to="12"><send>end_boss('titan','Rograg','tank')</send></trigger>
  <!-- Placeholders, need to get correct strings -->
  <trigger match="^Rograg gives the tank something (.+)\.$" regexp="y" enabled="n" group="me_titan" sequence="99" send_to="12"><send>end_boss('titan','Rograg',"%1")</send></trigger>
  <trigger match="^Hej gives Hej's something to (.+)\.$" regexp="y" enabled="n" group="me_titan" sequence="99" send_to="12"><send>end_boss('titan','Hej',"%1")</send></trigger>
  <trigger match="^Durthar gives Durthar's something to (.+)\.$" regexp="y" enabled="n" group="me_titan" sequence="99" send_to="12"><send>end_boss('titan','Durthar',"%1")</send></trigger>
  <!-- Shield and sanc, common Boss behaviour -->
  <trigger match="^(.+) wears a Mighty Shield as a shield\.$"                      regexp="y" enabled="n" group="me_titan" keep_evaluating="y" sequence="99" script="titan_shy"></trigger>
  <trigger match="^With awesome force (.+) cleaves (.+?)'?s? shield in half!$"     regexp="y" enabled="n" group="me_titan" keep_evaluating="y" sequence="99" script="titan_shn"></trigger>
  <trigger match="^(.+) quaffs a potion of Sanctuary.$"                            regexp="y" enabled="n" group="me_titan" keep_evaluating="y" sequence="99" script="titan_say"></trigger>
  <trigger match="^The white aura around (.+?)'?s? body vanishes.$"                regexp="y" enabled="n" group="me_titan" keep_evaluating="y" sequence="99" script="titan_san"></trigger>
  <!-- TERRA -->
  <trigger match="^The white aura around (.+?)'?s? body vanishes.$"                regexp="y" enabled="n" group="me_terra" keep_evaluating="y" sequence="99" script=""></trigger>
</triggers>

<!--  Aliases  -->

<aliases>
  <alias match="^miniepi?c?s?$"               regexp="y" enabled="y" script="miniepics_toggle"></alias>
  <alias match="^miniepi?c?s? (gt|say|echo)$" regexp="y" enabled="y" script="miniepics_channel"></alias>
  <alias match="^miniepi?c?s? help$"          regexp="y" enabled="y" script="miniepics_help"></alias>
  <alias match="^miniepi?c?s? test$"          regexp="y" enabled="y" script="miniepics_test"></alias>
  <alias match="^miniepi?c?s? test2$"         regexp="y" enabled="y" script="miniepics_test2"></alias>
  <alias match="^miniepi?c?s? debug$"         regexp="y" enabled="y" script="miniepics_debug"></alias>
</aliases>

<!--  Script  -->

<script>
<![CDATA[
-------------------
-- Helper functions
-------------------
function sb(b) if b then return 'true' else return 'false' end end
function gb(s) if s == 'true' then return true else return false end end
function PadString(str, len, char) if char == nil then char = ' ' end return string.rep(char, len - #str) .. str end
function sanitize(s) return s:gsub('[%p%c]','') end
function indexof(t, s) for k, v in ipairs(t) do if v == s then return true end end return false end
function AnsiNoteN(n, s) for i = n, 1, -1 do AnsiNote(s) end end
function dump(o)
  if type(o) == 'table' then
     local s = '{ '
     for k,v in pairs(o) do
        if type(k) ~= 'number' then k = '"'..k..'"' end
        s = s .. '['..k..'] = ' .. dump(v) .. ','
     end
     return s .. '} '
  else
     return tostring(o)
  end
end

-----------------
-- Default values
-----------------
require "gmcphelper"
require "serialize"
dofile(GetPluginInfo(GetPluginID(),20).."aardwolf_colors.lua")
local logo = ColoursToANSI('@Co-}@YHooK@C{-o  @x051M@x044i@x037n@x030i@x051E@x044p@x037i@x030cs @cv@C0@c.@C2')
local logoshort = ColoursToANSI('@Y[@x051M@x044i@x037n@x030i@x051E@x044p@x037i@x030cs@Y]')
local env_active = gb(GetVariable('env_active')) or true
local env_debug = gb(GetVariable('env_debug')) or false
local env_area = GetVariable('env_area') or 'out'
local env_chan = GetVariable('env_chan') or 'echo'
local bosstitan = { "Grakkr", "Hej", "Orzbuk", "Lugthurg", "Gjaka", "Morgak", "Durthar", "Rograg" }
local bossterra = { "Kjare", "Skeligh", "Yqath", "Vortath", "Salkin", "Nysil", "Yrelth", "Ksajus" }

------------------
-- Miniepics alias
------------------
function miniepics_toggle()
  if env_active then
    env_active = false
    SaveState()
    EnableTriggerGroup('me_titan', false) debugout('me_titan OFF')
    EnableTriggerGroup('me_terra', false) debugout('me_terra OFF')
    EnableTriggerGroup('me_bhits', false) debugout('me_bhits OFF')
    AnsiNote(logo..ColoursToANSI('@w miniepic triggers turned @ROFF'))
  else
    env_active = true
    SaveState()
    if gmcp('room.info.zone') == 'titan' then EnableTriggerGroup('me_titan', true) EnableTriggerGroup('me_bhits', true) debugout('me_titan ON') debugout('me_bhits ON') end
    if gmcp('room.info.zone') == 'terra' then EnableTriggerGroup('me_terra', true) EnableTriggerGroup('me_bhits', true) debugout('me_terra ON') debugout('me_bhits ON') end
    AnsiNote(logo..ColoursToANSI('@w miniepic triggers turned @GON'))
  end
end

function miniepics_debug()
  if env_debug then
    env_debug = false
    SaveState()
    AnsiNote(logo..ColoursToANSI('@w miniepic debugging turned @ROFF'))
  else
    env_debug = true
    SaveState()
    AnsiNote(logo..ColoursToANSI('@w miniepic debugging turned @GON'))
  end
end

function miniepics_channel(name, line, wc)
  env_chan = wc[1]
  SaveState()
  AnsiNote(logo..ColoursToANSI('@w miniepic channel set to @Y'..env_chan))
end

function miniepics_test()
  EnableTriggerGroup('me_titan', true)
  EnableTriggerGroup('me_bhits', true)
  SendNoEcho("echo With awesome force Pumpkin cleaves Grakkr's shield in half!")
  SendNoEcho("echo Grakkr wears a Mighty Shield as a shield.")
  SendNoEcho("echo Grakkr quaffs a potion of Sanctuary.")
  SendNoEcho("echo The white aura around Grakkr's body vanishes.")
end

function miniepics_test2()
  EnableTriggerGroup('me_titan', true)
  EnableTriggerGroup('me_bhits', true)
  SendNoEcho("echo Grakkr looks very uncomfortable.")
  SendNoEcho("echo Grakkr's ego is crushed by Tymme!")
  SendNoEcho("echo Grakkr looks tired and weak.")
  SendNoEcho("echo Grakkr appears extremely vulnerable as the mist surrounds it.")
end

--------------------
-- Trigger functions
--------------------
function titan_shy(name, line, wc)
  debugout('titan_shy function called, env_active is '..sb(env_active))
  if env_active then
    line = ' @R'..sanitize(wc[1])..' @Co-}@YShielded!@C{-o'
    if env_chan == 'echo' then AnsiNoteN(3, logoshort..ColoursToANSI(line)) end
    if env_chan == 'gt' then SendNoEcho('gt'..line) end
    if env_chan == 'say' then SendNoEcho('say'..line) end
  end
end

function titan_shn(name, line, wc)
  debugout('titan_shn function called, env_active is '..sb(env_active))
  if env_active then
    line = ' @G'..sanitize(wc[2])..' @Co-}@GShield destroyed!@C{-o @Yby '..sanitize(wc[1])
    if env_chan == 'echo' then AnsiNoteN(3, logoshort..ColoursToANSI(line)) end
    if env_chan == 'gt' then SendNoEcho('gt'..line) end
    if env_chan == 'say' then SendNoEcho('say'..line) end
  end
end

function titan_say(name, line, wc)
  debugout('titan_say function called, env_active is '..sb(env_active))
  if env_active then
    line = ' @R'..sanitize(wc[1]).." @Co-}@WSanc'ed!@C{-o"
    if env_chan == 'echo' then AnsiNoteN(3, logoshort..ColoursToANSI(line)) end
    if env_chan == 'gt' then SendNoEcho('gt'..line) end
    if env_chan == 'say' then SendNoEcho('say'..line) end
  end
end

function titan_san(name, line, wc)
  debugout('titan_san function called, env_active is '..sb(env_active))
  if env_active then
    debugout('titan_san wc[1] is: '..wc[1]..' and it returns '..sb(indexof(bosstitan, wc[1])))
    if indexof(bosstitan, wc[1]) then
      line = ' @G'..sanitize(wc[1])..' @Co-}@GDispelled sanctuary!@C{-o'
      if env_chan == 'echo' then AnsiNoteN(3, logoshort..ColoursToANSI(line)) end
      if env_chan == 'gt' then SendNoEcho('gt'..line) end
      if env_chan == 'say' then SendNoEcho('say'..line) end
    end
  end
end

function hit_warning(boss, always, spell)
  debugout('hit_warning function called, boss: '..boss..', always: '..always..', spell: '..spell)
    if env_active then
      if indexof(bosstitan, boss) or indexof(bossterra, boss) or boss:lower() == 'someone' then
        line = ' @Y'..sanitize(boss)..' @Co-}@W'..spell..'@C{-o @Yhit!'
        if env_chan == 'echo' then AnsiNote(logoshort..ColoursToANSI(line)) end
        if env_chan == 'gt' then SendNoEcho('gt'..line..'@Y') end
        if env_chan == 'say' then SendNoEcho('say'..line..'@C') end
      end
    end
end

-----------------
-- Zone awareness
-----------------
function OnPluginBroadcast(msg, id, name, text)
  if text == 'char.base' then
    Send_GMCP_Packet('request area')
    Send_GMCP_Packet('request room')
    debugout('We have reconnected, issue area/room request')
  end
  if env_active then
    -- if name ~= 'Aardwolf_Soundpack' and name ~= 'Galabans_Moons' and name ~= 'Aardwolf_GMCP_Mapper' and name ~= 'WinkleGold_Search_Destroy' and name ~= 'WinkleGold_Mapper_Extender' then
    --   debugout('msg: '..msg..', id: '..id..', name: '..name..', text: '..text) -- Ignore known broadcasts, give unknown ones
    -- end
    if name == 'GMCP_handler' then
      -- if string.match(text,'char.') then
      --   debugout(text..' received! This is what we have about it:')
      --   debugout(dump(gmcp(text)))
      -- elseif string.match(text,'room.') then
      --   debugout(text..' received! This is what we have about it:')
      --   debugout(dump(gmcp(text)))
      -- end
      if text == 'room.area' then
        debugout('room.area broadcast heard.')
        if gmcp('room.area.id') == 'titan' then
          if env_area ~= 'titan' then
            if env_area == 'terra' then
              AnsiNote(logo..ColoursToANSI(' @Co-}@Y'..string.upper(env_area)..'@C{-o @Warea left.'))
              EnableTriggerGroup('me_terra', false)
              debugout('me_terra trigger group OFF.')
              EnableTriggerGroup('me_bhits', false)
              debugout('me_bhits trigger group OFF.')
            end
            env_area = 'titan'
            EnableTriggerGroup('me_titan', true)
            debugout('me_titan trigger group ON.')
            EnableTriggerGroup('me_bhits', true)
            debugout('me_bhits trigger group ON.')
            SaveState()
            AnsiNote(logo..ColoursToANSI(' @Co-}@Y'..string.upper(env_area)..'@C{-o @Warea entered. Triggers are [@GON@W]'))
          end
        elseif gmcp('room.area.id') == 'terra' then
          if env_area ~= 'terra' then
            if env_area == 'titan' then
              AnsiNote(logo..ColoursToANSI(' @Co-}@Y'..string.upper(env_area)..'@C{-o @Warea left.'))
              EnableTriggerGroup('me_titan', false)
              debugout('me_titan trigger group OFF.')
              EnableTriggerGroup('me_bhits', false)
              debugout('me_bhits trigger group OFF.')
            end
            env_area = 'terra'
            EnableTriggerGroup('me_terra', true)
            debugout('me_terra trigger group ON.')
            EnableTriggerGroup('me_bhits', true)
            debugout('me_bhits trigger group ON.')
          SaveState()
            AnsiNote(logo..ColoursToANSI(' @Co-}@Y'..string.upper(env_area)..'@C{-o @Warea entered. Triggers are [@GON@W]'))
          end
        else
          if env_area == 'titan' or env_area == 'terra' then
            AnsiNote(logo..ColoursToANSI(' @Co-}@Y'..string.upper(env_area)..'@C{-o @Warea left.'))
            env_area = 'out'
            EnableTriggerGroup('me_titan', false)
            debugout('me_titan trigger group OFF.')
            EnableTriggerGroup('me_terra', false)
            debugout('me_terra trigger group OFF.')
            EnableTriggerGroup('me_bhits', false)
            debugout('me_bhits trigger group OFF.')
            SaveState()
          end
        end
      end
      -- if env_area == 'titan' then
      --   if text == 'room.info' then
      --     if gmpc('room.info.num') == 'neki broj' then
      --       Note('Daj informaciju o kojem se bossu radi')
      --     end
      --   end
      -- end
    end
  end
end

-------------------
-- Helpers - output
-------------------
function miniepics_help()
  AnsiNote(ColoursToANSI('@C{-o @Y----------------@C[  ')..logo..ColoursToANSI('  @C]@Y---------------- @Co-}@w'))
  AnsiNote()
  AnsiNote(ColoursToANSI('  @CCommands:'))
  AnsiNote(ColoursToANSI('    @Yminiepics        @w- switch plugin ON / OFF'))
  AnsiNote(ColoursToANSI('    @Yminiepics help   @w- this screen'))
  AnsiNote(ColoursToANSI('    @Yminiepics gt     @w- set output channel to group tell'))
  AnsiNote(ColoursToANSI('    @Yminiepics say    @w- set output channel to say'))
  AnsiNote(ColoursToANSI('    @Yminiepics echo   @w- set output channel to local echo'))
  -- AnsiNote(ColoursToANSI('    @Yminiepics debug  @w- toggle debug info'))
  AnsiNote()
  AnsiNote(ColoursToANSI('  @CUsage:'))
  AnsiNote(ColoursToANSI('    @wPlugin will autodetect your current zone and activate'))
  AnsiNote(ColoursToANSI('    @wrequired triggers that report to group channel.'))
  AnsiNote()
  AnsiNote(ColoursToANSI('@C{-o @Y---------------------------------------------------------------- @Co-}@w'))
end

function debugout(e)
  if env_debug then
    AnsiNote(logo..ColoursToANSI(' @Y[@ydebug@Y] @W'..e))
  end
end

function noteout(e)
  AnsiNote(logo..e)
end

function OnPluginInstall()
  AnsiNote(logo..ColoursToANSI('@w type @Yminiepics help @wfor commands and usage info.'))
end

function OnPluginSaveState()
  -- this will run when SaveState() is called or if mush is closing etc
  SetVariable('env_area', env_area)
  SetVariable('env_chan', env_chan)
  SetVariable('env_active', sb(env_active))
  SetVariable('env_debug', sb(env_debug))
end


]]>
</script> 

</muclient>
