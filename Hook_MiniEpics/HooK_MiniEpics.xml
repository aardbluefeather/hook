<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<muclient>
<plugin
   name="HooK_MiniEpics"
   author="BlueFeather"
   id="2a0221da142c2505699c5adb"
   language="Lua"
   purpose="Mini epic (Titan/Terra) triggers and reports"
   save_state="y"
   date_written="2019-06-26 21:47:01"
   requires="5.06"
   version="0.81"
   >
<description trim="y">
<![CDATA[
A collection of triggers for use in Titan and Terra miniepics - to make life there easier.
]]>
</description>

</plugin>


<!--  Get our standard constants -->

<include name="constants.lua"/>

<!--  #region Triggers  -->
<triggers>
  <!-- Boss hits -->
  <trigger match="^(.+) looks very uncomfortable\.$"                               regexp="y" enabled="n" group="me_bhits" sequence="99" send_to="12"><send>hit_warning("%1",'y','Curse')</send></trigger>
  <trigger match="^You ridicule (.+) about \w+ childhood\.$"                       regexp="y" enabled="n" group="me_bhits" sequence="99" send_to="12"><send>hit_warning("%1",'n','Ego Whip')</send></trigger>
  <trigger match="^(.+?)'?s? ego is crushed by \w+!$"                              regexp="y" enabled="n" group="me_bhits" sequence="99" send_to="12"><send>hit_warning("%1",'n','Ego Whip')</send></trigger>
  <trigger match="^(.+) looks very ill\.$"                                         regexp="y" enabled="n" group="me_bhits" sequence="99" send_to="12"><send>hit_warning("%1",'n','Poison')</send></trigger>
  <trigger match="^You mark (.+) with a Rune of IX!$"                              regexp="y" enabled="n" group="me_bhits" sequence="99" send_to="12"><send>hit_warning("%1",'y','Rune of IX')</send></trigger>
  <trigger match="^(.+?)'?s? armor softens\.$"                                     regexp="y" enabled="n" group="me_bhits" sequence="99" send_to="12"><send>hit_warning("%1",'n','Soften')</send></trigger>
  <trigger match="^(.+) looks tired and weak\.$"                                   regexp="y" enabled="n" group="me_bhits" sequence="99" send_to="12"><send>hit_warning("%1",'n','Weaken')</send></trigger>
  <trigger match="^(.+) looks unwell\.$"                                           regexp="y" enabled="n" group="me_bhits" sequence="99" send_to="12"><send>hit_warning("%1",'n','Disease')</send></trigger>
  <trigger match="^(.+?)'?s? flesh is ripped from \w+ body\.$"                     regexp="y" enabled="n" group="me_bhits" sequence="99" send_to="12"><send>hit_warning("%1",'n','Raw Flesh')</send></trigger>
  <trigger match="^(.+) looks unwell\.$"                                           regexp="y" enabled="n" group="me_bhits" sequence="99" send_to="12"><send>hit_warning("%1",'n','Disease')</send></trigger>
  <trigger match="^(.+) appears to falter. Your victim is in serious trouble!$"    regexp="y" enabled="n" group="me_bhits" sequence="99" send_to="12"><send>hit_warning("%1",'n','Hydra Blood')</send></trigger>
  <trigger match="^(.+) appears pale and weak\.$"                                  regexp="y" enabled="n" group="me_bhits" sequence="99" send_to="12"><send>hit_warning("%1",'n','Hydra Blood')</send></trigger>
  <trigger match="^Your acidic venom burns away (.+?)'?s? armor\.$"                regexp="y" enabled="n" group="me_bhits" sequence="99" send_to="12"><send>hit_warning("%1",'n','Raven Scourge')</send></trigger>
  <trigger match="^(.+) appears much weaker and extremely vulnerable\.$"           regexp="y" enabled="n" group="me_bhits" sequence="99" send_to="12"><send>hit_warning("%1",'n','Green Death')</send></trigger>
  <trigger match="^(.+) appears extremely vulnerable as the mist surrounds \w+\.$" regexp="y" enabled="n" group="me_bhits" sequence="99" send_to="12"><send>hit_warning("%1",'n','Green Death')</send></trigger>
  <trigger match="^(.+) turns pale and appears weakened\.$"                        regexp="y" enabled="n" group="me_bhits" sequence="99" send_to="12"><send>hit_warning("%1",'y','Kobold Spray')</send></trigger>
  <trigger match="^(.+?)'?s? body starts to weaken\.$"                             regexp="y" enabled="n" group="me_bhits" sequence="99" send_to="12"><send>hit_warning("%1",'n','Hex of Entropy')</send></trigger>
  <!-- TITAN -->
  <!-- Run start and end -->
  <trigger match="^You receive Rune of Passage from Salkin\.$"            regexp="y" enabled="n" group="me_titan" sequence="99" script="start_area"></trigger>
  <trigger match="^You receive Salkin's Reward from Salkin\.$"            regexp="y" enabled="n" group="me_titan" sequence="99" script="end_area"></trigger>
  <trigger match="^Salkin snaps his fingers; your rune glows faintly!$"   regexp="y" enabled="n" group="me_titan" sequence="99" send_to="12"><send>EnableTriggerGroup('me_start', true)</send></trigger>
  <!-- Boss start -->
  <trigger match="^At the edge of the Abyss$" regexp="y" enabled="n" group="me_start" sequence="80" send_to="12"><send>start_boss('titan','Durthar')</send></trigger>
  <trigger match="^Shattered reality$"        regexp="y" enabled="n" group="me_start" sequence="80" send_to="12"><send>start_boss('titan','Gjaka')</send></trigger>
  <trigger match="^A small chamber$"          regexp="y" enabled="n" group="me_start" sequence="80" send_to="12"><send>start_boss('titan','Grakkr')</send></trigger>
  <trigger match="^A vast plain$"             regexp="y" enabled="n" group="me_start" sequence="80" send_to="12"><send>start_boss('titan','Hej')</send></trigger>
  <trigger match="^A crystal chamber$"        regexp="y" enabled="n" group="me_start" sequence="80" send_to="12"><send>start_boss('titan','Lugthurg')</send></trigger>
  <trigger match="^A large arena$"            regexp="y" enabled="n" group="me_start" sequence="80" send_to="12"><send>start_boss('titan','Morgak')</send></trigger>
  <trigger match="^A crystal seal$"           regexp="y" enabled="n" group="me_start" sequence="80" send_to="12"><send>start_boss('titan','Orzbuk')</send></trigger>
  <trigger match="^A ritual chamber$"         regexp="y" enabled="n" group="me_start" sequence="80" send_to="12"><send>start_boss('titan','Rograg')</send></trigger>
  <!-- Boss end v1 -->
  <trigger match="^Durthar gives Durthar's Speed to (.+)\.$"     regexp="y" enabled="n" group="Durthar"  sequence="99" send_to="12"><send>end_boss('titan','Durthar',"%1")</send></trigger>
  <trigger match="^Gjaka gives Gjaka's Burden to (.+)\.$"        regexp="y" enabled="n" group="Gjaka"    sequence="99" send_to="12"><send>end_boss('titan','Gjaka',"%1")</send></trigger>
  <trigger match="^Grakkr gives Grakkr's Leadership to (.+)\.$"  regexp="y" enabled="n" group="Grakkr"   sequence="99" send_to="12"><send>end_boss('titan','Grakkr',"%1")</send></trigger>
  <trigger match="^.+ Hej gives Hej's Compendium to (.+)\.$"     regexp="y" enabled="n" group="Hej"      sequence="99" send_to="12"><send>end_boss('titan','Hej',"%1")</send></trigger>
  <trigger match="^Lugthurg gives Lugthurg's Bones to (.+)\.$"   regexp="y" enabled="n" group="Lugthurg" sequence="99" send_to="12"><send>end_boss('titan','Lugthurg',"%1")</send></trigger>
  <trigger match="^Morgak gives Morgak's Silence to (.+)\.$"     regexp="y" enabled="n" group="Morgak"   sequence="99" send_to="12"><send>end_boss('titan','Morgak',"%1")</send></trigger>
  <trigger match="^Orzbuk's .+ gives Orzbuk's Vision to (.+)\.$" regexp="y" enabled="n" group="Orzbuk"   sequence="99" send_to="12"><send>end_boss('titan','Orzbuk',"%1")</send></trigger>
  <trigger match="^Once the Titan General is slain, Salkin quickly leads you back to the secret junction\.$" regexp="y" enabled="n" group="Rograg" sequence="99" send_to="12"><send>end_boss('titan','Rograg','tank')</send></trigger>
  <!-- Boss end v2 -->
  <trigger match="^You (?:receive|get) Durthar's Speed from .+$"     regexp="y" enabled="n" group="Durthar"  sequence="99" send_to="12"><send>end_boss('titan','Durthar',"me")</send></trigger>
  <trigger match="^You (?:receive|get) Gjaka's Burden from .+$"      regexp="y" enabled="n" group="Gjaka"    sequence="99" send_to="12"><send>end_boss('titan','Gjaka',"me")</send></trigger>
  <trigger match="^You (?:receive|get) Grakkr's Leadership from .+$" regexp="y" enabled="n" group="Grakkr"   sequence="99" send_to="12"><send>end_boss('titan','Grakkr',"me")</send></trigger>
  <trigger match="^You (?:receive|get) Hej's Compendium from .+$"    regexp="y" enabled="n" group="Hej"      sequence="99" send_to="12"><send>end_boss('titan','Hej',"me")</send></trigger>
  <trigger match="^You (?:receive|get) Lugthurg's Bones from .+$"    regexp="y" enabled="n" group="Lugthurg" sequence="99" send_to="12"><send>end_boss('titan','Lugthurg',"me")</send></trigger>
  <trigger match="^You (?:receive|get) Morgak's Silence from .+$"    regexp="y" enabled="n" group="Morgak"   sequence="99" send_to="12"><send>end_boss('titan','Morgak',"me")</send></trigger>
  <trigger match="^You (?:receive|get) Orzbuk's Vision from .+$"     regexp="y" enabled="n" group="Orzbuk"   sequence="99" send_to="12"><send>end_boss('titan','Orzbuk',"me")</send></trigger>
  <trigger match="^You (?:receive|get) Rograg's Greaves from .+$"    regexp="y" enabled="n" group="Rograg"   sequence="99" send_to="12"><send>end_boss('titan','Rograg','me')</send></trigger>
  <!-- Boss end v3 -->
  <trigger match="^.+ gives you Durthar's Speed\.$"     regexp="y" enabled="n" group="Durthar"  sequence="99" send_to="12"><send>end_boss('titan','Durthar',"me")</send></trigger>
  <trigger match="^.+ gives you Gjaka's Burden\.$"      regexp="y" enabled="n" group="Gjaka"    sequence="99" send_to="12"><send>end_boss('titan','Gjaka',"me")</send></trigger>
  <trigger match="^.+ gives you Grakkr's Leadership\.$" regexp="y" enabled="n" group="Grakkr"   sequence="99" send_to="12"><send>end_boss('titan','Grakkr',"me")</send></trigger>
  <trigger match="^.+ gives you Hej's Compendium\.$"    regexp="y" enabled="n" group="Hej"      sequence="99" send_to="12"><send>end_boss('titan','Hej',"me")</send></trigger>
  <trigger match="^.+ gives you Lugthurg's Bones\.$"    regexp="y" enabled="n" group="Lugthurg" sequence="99" send_to="12"><send>end_boss('titan','Lugthurg',"me")</send></trigger>
  <trigger match="^.+ gives you Morgak's Silence\.$"    regexp="y" enabled="n" group="Morgak"   sequence="99" send_to="12"><send>end_boss('titan','Morgak',"me")</send></trigger>
  <trigger match="^.+ gives you Orzbuk's Vision\.$"     regexp="y" enabled="n" group="Orzbuk"   sequence="99" send_to="12"><send>end_boss('titan','Orzbuk',"me")</send></trigger>
  <trigger match="^.+ gives you Rograg's Greaves\.$"    regexp="y" enabled="n" group="Rograg"   sequence="99" send_to="12"><send>end_boss('titan','Rograg','me')</send></trigger>
  <!-- Boss end v4 - fallback -->
  <trigger match="^.+ gives? Durthar's Speed to Salkin\.$"        regexp="y" enabled="n" group="Durthar"  sequence="99" send_to="12"><send>end_boss('titan','Durthar')</send></trigger>
  <trigger match="^.+ gives? Gjaka's Burden to Salkin\.$"         regexp="y" enabled="n" group="Gjaka"    sequence="99" send_to="12"><send>end_boss('titan','Gjaka')</send></trigger>
  <trigger match="^.+ gives? Grakkr's Leadership to Salkin\.$"    regexp="y" enabled="n" group="Grakkr"   sequence="99" send_to="12"><send>end_boss('titan','Grakkr')</send></trigger>
  <trigger match="^.+ gives? Hej's Compendium to Salkin\.$"       regexp="y" enabled="n" group="Hej"      sequence="99" send_to="12"><send>end_boss('titan','Hej')</send></trigger>
  <trigger match="^.+ gives? Lugthurg's Bones to Salkin\.$"       regexp="y" enabled="n" group="Lugthurg" sequence="99" send_to="12"><send>end_boss('titan','Lugthurg')</send></trigger>
  <trigger match="^.+ gives? Morgak's Silence to Salkin\.$"       regexp="y" enabled="n" group="Morgak"   sequence="99" send_to="12"><send>end_boss('titan','Morgak')</send></trigger>
  <trigger match="^.+ gives? Orzbuk's Vision to Salkin\.$"        regexp="y" enabled="n" group="Orzbuk"   sequence="99" send_to="12"><send>end_boss('titan','Orzbuk')</send></trigger>
  <trigger match="^.+ gives? Rograg's Greaves to Salkin\.$"       regexp="y" enabled="n" group="Rograg"   sequence="99" send_to="12"><send>end_boss('titan','Rograg')</send></trigger>
  <!-- Shield and sanc, common Boss behaviour -->
  <trigger match="^(.+) wears a Mighty Shield as a shield\.$"                      regexp="y" enabled="n" group="me_titan" keep_evaluating="y" sequence="99" script="titan_shy"></trigger>
  <trigger match="^With awesome force (.+) cleaves (.+?)'?s? shield in half!$"     regexp="y" enabled="n" group="me_titan" keep_evaluating="y" sequence="99" script="titan_shn"></trigger>
  <trigger match="^Your mighty strike cleaves (.+?)'?s? shield in half!$"          regexp="y" enabled="n" group="me_titan" keep_evaluating="y" sequence="99" script="titan_shm"></trigger>
  <trigger match="^(.+) quaffs a potion of Sanctuary.$"                            regexp="y" enabled="n" group="me_titan" keep_evaluating="y" sequence="99" script="titan_say"></trigger>
  <trigger match="^The white aura around (.+?)'?s? body vanishes.$"                regexp="y" enabled="n" group="me_titan" keep_evaluating="y" sequence="99" script="titan_san"></trigger>
  <!-- TITAN - Boss specific announcements -->
  <!-- Durthar -->
  <trigger match="^Durthar exclaims 'Enough! Begone, little ants!'$"                   regexp="y" enabled="n" group="Durthar" keep_evaluating="n" sequence="99" send_to="12"><send>fn_durthar('trans')</send></trigger>
  <trigger match="^Durthar fades into existence\.$"                                    regexp="y" enabled="n" group="Durthar" keep_evaluating="n" sequence="99" send_to="12"><send>fn_durthar('rep')</send></trigger>
  <trigger match="^.+ A Titan treads the knife's edge between Reality and the Void\.$" regexp="y" enabled="n" group="Durthar" keep_evaluating="n" sequence="99" send_to="12"><send>fn_durthar('rep')</send></trigger>
  <trigger match="^.+ Durthar is fighting .+$"                                         regexp="y" enabled="n" group="Durthar" keep_evaluating="n" sequence="99" send_to="12"><send>fn_durthar('rep')</send></trigger>
  <!-- Lugthurg -->
  <trigger match="^Lugthurg begins to observe your movements with intense focus\.\.\.$"                             regexp="y" enabled="n" group="Lugthurg" keep_evaluating="n" sequence="99" send_to="12"><send>fn_lugthurg('obs')</send></trigger>
  <trigger match="^Lugthurg grins at you, and his eyes seem to read you like an open book\.$"                       regexp="y" enabled="n" group="Lugthurg" keep_evaluating="n" sequence="99" send_to="12"><send>fn_lugthurg('pan')</send></trigger>
  <trigger match="^Lugthurg gazes at you with a blank look, as though he has just forgotten something important\.$" regexp="y" enabled="n" group="Lugthurg" keep_evaluating="n" sequence="99" send_to="12"><send>fn_lugthurg('end')</send></trigger>
  <trigger match="^(?:.*)Lugthurg is trying to KILL YOU!$"                                                          regexp="y" enabled="n" group="Lugthurg" keep_evaluating="n" sequence="99" send_to="12"><send>fn_lugthurg('tar')</send></trigger>
  <trigger match="^(?:.*)Lugthurg is fighting (?:.+)\.$"                                                            regexp="y" enabled="n" group="Lugthurg" keep_evaluating="n" sequence="99" send_to="12"><send>fn_lugthurg('saf')</send></trigger>
  <trigger match="^(?:.+) rescues you!$"                                                                            regexp="y" enabled="n" group="Lugthurg" keep_evaluating="n" sequence="99" send_to="12"><send>fn_lugthurg('saf')</send></trigger>
  <!-- Rograg -->
  <trigger match="^As an Ethereal Guardian fades away, the altar glows faintly red\.$" regexp="y" enabled="n" group="Rograg" keep_evaluating="n" sequence="99" send_to="12"><send>fn_rograg('red')</send></trigger>
  <!-- Orzbuk -->
  <trigger match="^A crystal seal$" regexp="y" enabled="y" group="Orzbuk" keep_evaluating="n" sequence="105" send_to="12"><send>fn_orzbuk('catch')</send></trigger>
  <!-- Grakkr -->
  <trigger match="^An Aura of Protective Magic begins floating around \S+\.$" regexp="y" enabled="y" group="Grakkr" keep_evaluating="n" sequence="99" send_to="12"><send>fn_grakkr('init')</send></trigger>

  <!-- TERRA -->
  <trigger match="^The white aura around (.+?)'?s? body vanishes.$"                regexp="y" enabled="n" group="me_terra" keep_evaluating="y" sequence="99" script=""></trigger>
</triggers>
<!--  #endregion  -->

<!--  #region Aliases  -->
<aliases>
  <alias match="^miniepi?c?s?$"               regexp="y" keep_evaluating="n" sequence="91" enabled="y" script="miniepics_toggle"></alias>
  <alias match="^miniepi?c?s? (gt|say|echo)$" regexp="y" keep_evaluating="n" sequence="91" enabled="y" script="miniepics_channel"></alias>
  <alias match="^miniepi?c?s? v(1|2|3|4)$"    regexp="y" keep_evaluating="n" sequence="91" enabled="y" script="miniepics_verbosity"></alias>
  <alias match="^miniepi?c?s? commlog$"       regexp="y" keep_evaluating="n" sequence="91" enabled="y" script="miniepics_commlog"></alias>
  <alias match="^miniepi?c?s? help$"          regexp="y" keep_evaluating="n" sequence="91" enabled="y" script="miniepics_help"></alias>
  <alias match="^miniepi?c?s? test1$"         regexp="y" keep_evaluating="n" sequence="91" enabled="y" script="miniepics_test1"></alias>
  <alias match="^miniepi?c?s? test2$"         regexp="y" keep_evaluating="n" sequence="91" enabled="y" script="miniepics_test2"></alias>
  <alias match="^miniepi?c?s? test3$"         regexp="y" keep_evaluating="n" sequence="91" enabled="y" script="miniepics_test3"></alias>
  <alias match="^miniepi?c?s? test4$"         regexp="y" keep_evaluating="n" sequence="91" enabled="y" script="miniepics_test4"></alias>
  <alias match="^miniepi?c?s? (Durthar|Gjaka|Grakkr|Hej|Lugthurg|Morgak|Orzbuk|Rograg)$" regexp="y" keep_evaluating="n" sequence="91" enabled="y" script="miniepics_test_boss"></alias>
  <alias match="^miniepi?c?s? debug$"         regexp="y" keep_evaluating="n" sequence="91" enabled="y" script="miniepics_debug"></alias>
  <alias match="^miniepi?c?s?.+$"             regexp="y" keep_evaluating="n" sequence="99" enabled="y" script="miniepics_badcommand"></alias>
  <alias match="^miniexplain$"     name="miniexplain"                regexp="y" sequence="99" enabled="n" script="miniepics_explain"></alias>
  <alias match="^repo?r?t?$"       name="Durthar"  group="TitanBoss" keep_evaluating="n" regexp="y" sequence="99" enabled="n" send_to="12"><send>fn_durthar('report')</send></alias>
  <alias match="^repo?r?t?$"       name="Gjaka"    group="TitanBoss" keep_evaluating="n" regexp="y" sequence="99" enabled="n" send_to="12"><send>fn_gjaka('report')</send></alias>
  <alias match="^repo?r?t? (\S+)$" name="Grakkr"   group="TitanBoss" keep_evaluating="n" regexp="y" sequence="99" enabled="n" send_to="12"><send>fn_grakkr('report', '%1')</send></alias>
  <alias match="^repo?r?t?$"       name="Hej"      group="TitanBoss" keep_evaluating="n" regexp="y" sequence="99" enabled="n" send_to="12"><send>fn_hej('report')</send></alias>
  <alias match="^repo?r?t?$"       name="Lugthurg" group="TitanBoss" keep_evaluating="n" regexp="y" sequence="99" enabled="n" send_to="12"><send>fn_lugthurg('report')</send></alias>
  <alias match="^repo?r?t?$"       name="Morgak"   group="TitanBoss" keep_evaluating="n" regexp="y" sequence="99" enabled="n" send_to="12"><send>fn_morgak('report')</send></alias>
  <alias match="^repo?r?t?$"       name="Orzbuk"   group="TitanBoss" keep_evaluating="n" regexp="y" sequence="99" enabled="n" send_to="12"><send>fn_orzbuk('report')</send></alias>
  <alias match="^repo?r?t?$"       name="Rograg"   group="TitanBoss" keep_evaluating="n" regexp="y" sequence="99" enabled="n" send_to="12"><send>fn_rograg('report')</send></alias>
</aliases>
<!--  #endregion  -->

<!--  Script  -->

<script>
<![CDATA[
---------------------------
-- #region Helper functions
---------------------------
function sb(b) if b then return 'true' else return 'false' end end
function gb(s) if s == 'true' then return true else return false end end
function PadString(str, len, char) if char == nil then char = ' ' end return string.rep(char, len - #str) .. str end
function sanitize(s) return s:gsub('[%p%c]','') end
function indexof(t, s) for k, v in ipairs(t) do if v == s then return true end end return false end
function AnsiNoteN(n, s) for i = n, 1, -1 do AnsiNote(s) end end
function dump(o)
  if type(o) == 'table' then
     local s = '{ '
     for k,v in pairs(o) do
        if type(k) ~= 'number' then k = '"'..k..'"' end
        s = s .. '['..k..'] = ' .. dump(v) .. ','
     end
     return s .. '} '
  else
     return tostring(o)
  end
end
function SecondsToClock(s)
  local s = tonumber(s)
  if s <= 0 then return ClockFormat(0,0,0);
  else h = math.floor(s/3600); m = math.floor(s/60 - (h*60)); s = math.floor(s - h*3600 - m*60); return ClockFormat(h,m,s)
  end
end
function ClockFormat(h,m,s) return '@W'..string.format('%02.f', h)..'@wh @W'..string.format('%02.f', m)..'@wm @W'..string.format('%02.f', s)..'@ws' end
-- #endregion
-------------------------
-- #region Default values
-------------------------
require "gmcphelper"
require "serialize"
require "wait"
dofile(GetPluginInfo(GetPluginID(),20).."aardwolf_colors.lua")
local logo = ColoursToANSI('@Co-}@YHooK@C{-o @x051M@x044i@x037n@x030i@x051E@x044p@x037i@x030cs @cv@C0@c.@C81')
local logoshort = ColoursToANSI('@Y[@x051M@x044i@x037n@x030i@x051E@x044p@x037i@x030cs@Y]')
local env_active = gb(GetVariable('env_active')) or true
local env_debug = gb(GetVariable('env_debug')) or false
local env_commlog = gb(GetVariable('env_commlog')) or false
local env_area = GetVariable('env_area') or 'out'
local env_chan = GetVariable('env_chan') or 'echo'
local env_verbosity = tonumber(GetVariable('env_verbosity')) or 3
local env_verbosity_name = {'crucial', 'important', 'interesting', 'spammy'}
local env_orzbuk_default = {["Orzbuk's right leg"] = true,["Orzbuk's left leg"] = true,["Orzbuk's right arm"] = true,["Orzbuk's left arm"] = true}
local env_orzbuk = false
local bosstitan = { "Grakkr", "Hej", "Orzbuk", "Lugthurg", "Gjaka", "Morgak", "Durthar", "Rograg" }
local bossterra = { "Kjare", "Skeligh", "Yqath", "Vortath", "Salkin", "Nysil", "Yrelth", "Ksajus" }
local bossinfo = {
  durthar = {
    name = 'Durthar',
    item = "Durthar's Speed",
    short = '@wthe "@Gfind me in the maze@w" boss.',
    long = "This boss fight involves a randomized maze that the boss randomly transfers around in. The random transfer happen when Durthar reaches 80/60/40/20/10% HP. As the boss fight goes on, tendrils are randomly populated through the maze. These tendrils are not killable, but they can be tamed. The best practice is to retreat, flee or mist form. Good practice is to place pets close to boss for easier navigation."
  },
  gjaka = {
    name = 'Gjaka',
    item = "Gjaka's Burden",
    short = '@wthe "@Gfight him with low hp@w" boss.',
    long = "This boss will switch his HP% with a random member in the group at 80/60/40/20%. If the random group member has a higher HP% than Grakkr, Grakkr will take their HP% as his own. The typical strategy for this boss is to have one person tank Grakkr. The rest of the group will turn autoassist off, flee off Grakkr, and keep moving east until their HP% is around 20%. After that, just tank and spank."
  },
  grakkr = {
    name = 'Grakkr',
    item = "Grakkr's Leadership",
    short = '@wthe "@Gchange your damtype@w" boss.',
    long = "The boss wears a special aura that changes up his resistances every so often. You will want to switch through the different damage types to find his vulnerabilities. Damage groups are: [Cold-Acid-Bash], [Holy-Shadow-Mental], [Negative-Fire-Light], [Magic-Energy-Earth], [Pierce-Air-Electric], [Water-Slash-Sonic]"
  },
  hej = {
    name = 'Hej',
    item = "Hej's Compendium",
    short = '@wthe "@Gbody, mind and soul@w" boss.',
    long = "This boss is split into three mobs: body, mind, and soul. During this boss fight, you will want to keep each of them fully webbed and kill them at about the same time. The three mobs will try to unite in a room. If this happens, you will want to find an 'anomaly' on the floor and hand it to one of the mobs to split them apart. When the mobs in a room together, their damage is multiplied and makes it hard to withstand the damage."
  },
  lugthurg = {
    name = 'Lugthurg',
    item = "Lugthurg's Bones",
    short = '@wthe "@Gobserving@w" boss.',
    long = "Throughout the fight, the boss will randomly observe individuals. If the observed individuals are tanking Lugthurg at the time of his random slicings, they will take massive amounts of damage. Only observed individual will see that the boss is observing them, so they will need to call it out, so they can be rescued."
  },
  morgak = {
    name = 'Morgak',
    item = "Morgak's Silence",
    short = '@wthe "@Gexploding runes@w" boss.',
    long = "This boss will randomly place runes inside of his 3x3 room dungeon. If the runes are visible on the map, you will want to avoid those rooms or they will explode on entry. If the runes do not appear on map, you can run through the room until you find one without a rune. The object is to dodge the runes and kill Morgak after dodging the runes."
  },
  orzbuk = {
    name = 'Orzbuk',
    item = "Orzbuk's Vision",
    short = '@wthe "@G4 piece@w" boss.',
    long = "This boss is a total of 4 mobs: right leg, left leg, right arm, left arm. The group will want to quickly cast 'reverse align' on each of the mobs to reduce the damage from the mobs. The best strategy is to split up tanking of each mob amongst the group. After all the mobs have dropped below 90/80/70/60/50/40/30/20/10%, the group will get their HP restored."
  },
  rograg = {
    name = 'Rograg',
    item = "Rograg's Greaves",
    short = '@wthe "@Galtar@w" boss.',
    long = "Main tank will 'nod salkin' to get transferred to Rograg. The rest will kill the guardians until they find red color of the altar. Then the titan in the center will be pushed to that altar, killed, and the heart sacrificed. Another titan will appear in his place (not in center). Keep killing the titans and sacrificing the heart."
  }
}
local study_patterns = {
  {match = "You .+", val = "me", avg = 0},
  {match = "(.+) is in perfect health.", val = "100%", avg = 100},
  {match = "(.+) has a few minor scratches.", val = "99% - 95%", avg = 97},
  {match = "(.+) is showing a few grazes.", val = "94% - 85%", avg = 90},
  {match = "(.+) is bleeding lightly.", val = "84% - 75%", avg = 80},
  {match = "(.+) has some small wounds and bruises.", val = "74% - 65%", avg = 70},
  {match = "(.+) is showing a few battle scars.", val = "64% - 55%", avg = 60},
  {match = "(.+) has quite a few wounds.", val = "54% - 45%", avg = 50},
  {match = "(.+) has some big nasty wounds and scratches.", val = "44% - 35%", avg = 40},
  {match = "(.+) has some very nasty wounds.", val = "34% - 25%", avg = 30},
  {match = "(.+) needs a hospital.", val = "24% - 15%", avg = 20},
  {match = "(.+) is gravely injured.", val = "14% - 5%", avg = 10},
  {match = "(.+) is at death's door.", val = "4% - 0%", avg = 2}
}
-- #endregion
--------------------------
-- #region Miniepics alias
--------------------------
function miniepics_toggle()
  if env_active then
    env_active = false
    SaveState()
    EnableTriggerGroup('me_titan', false) debugout('me_titan OFF')
    EnableTriggerGroup('me_terra', false) debugout('me_terra OFF')
    EnableTriggerGroup('me_bhits', false) debugout('me_bhits OFF')
    writeout('@wminiepic plugin turned @ROFF', 1, 'echo')
  else
    env_active = true
    SaveState()
    debugout('zone is: '..gmcp('room.info.zone'))
    if gmcp('room.info.zone') == 'titan' then EnableTriggerGroup('me_titan', true) EnableTriggerGroup('me_bhits', true) debugout('me_titan ON') debugout('me_bhits ON') end
    if gmcp('room.info.zone') == 'terra' then EnableTriggerGroup('me_terra', true) EnableTriggerGroup('me_bhits', true) debugout('me_terra ON') debugout('me_bhits ON') end
    writeout('@wminiepic plugin turned @GON', 1, 'echo')
  end
end

function miniepics_commlog()
  if env_commlog then
    env_commlog = false
    SaveState()
    writeout('@wcommunication log integration is [@ROFF@w]', 1, 'echo')
  else
    env_commlog = true
    SaveState()
    writeout('@wcommunication log integration is [@GON@w]', 1, 'echo')
  end
end

function miniepics_verbosity(name, line, wc)
  env_verbosity = tonumber(wc[1])
  SaveState()
  writeout('@wminiepic verbosity level set to [@Y'..env_verbosity..'@w] - @Y'..env_verbosity_name[env_verbosity], 1, 'echo')
end

function miniepics_debug()
  if env_debug then
    env_debug = false
    SaveState()
    writeout('@wminiepic debugging turned @ROFF', 1, 'echo')
  else
    env_debug = true
    SaveState()
    writeout('@wminiepic debugging turned @GON', 1, 'echo')
  end
end

function miniepics_channel(name, line, wc)
  env_chan = wc[1]
  SaveState()
  writeout('@wminiepic channel set to @Y'..env_chan, 1, 'echo')
end

function miniepics_test1()
  env_area = 'titan'
  EnableTriggerGroup('me_titan', true)
  EnableTriggerGroup('me_bhits', true)
  env_boss = { id = 'grakkr' }
  env_bosscount = 1
  SendNoEcho("echo With awesome force Pumpkin cleaves Grakkr's shield in half!")
  SendNoEcho("echo Grakkr wears a Mighty Shield as a shield.")
  SendNoEcho("echo Grakkr quaffs a potion of Sanctuary.")
  SendNoEcho("echo The white aura around Grakkr's body vanishes.")
end

function miniepics_test2()
  env_area = 'titan'
  EnableTriggerGroup('me_titan', true)
  EnableTriggerGroup('me_bhits', true)
  env_boss = { id = 'grakkr' }
  env_bosscount = 1
  SendNoEcho("echo Grakkr looks very uncomfortable.")
  SendNoEcho("echo Grakkr's ego is crushed by Tymme!")
  SendNoEcho("echo Grakkr looks tired and weak.")
  SendNoEcho("echo Grakkr appears extremely vulnerable as the mist surrounds it.")
end

function miniepics_test3()
  env_area = 'titan'
  EnableTriggerGroup('me_titan', true)
  EnableTriggerGroup('me_bhits', true)
  SendNoEcho("echo You receive Rune of Passage from Salkin.")
  SendNoEcho("echo Tester takes a deep breath, then leaves down a passage.")
  SendNoEcho("echo Shattered reality")
  DoAfterSpecial(2, "miniepics_explain()", 12)
  DoAfter(3, "echo RedFeather gives Gjaka's Burden to Salkin.")
  DoAfter(4, "echo Tester takes a deep breath, then leaves down a passage.")
  DoAfter(5, "echo A crystal chamber")
  DoAfterSpecial(6, "miniepics_explain()", 12)
  DoAfter(7, "echo Lugthurg gives Lugthurg's Bones to BlueFeather.")
  DoAfter(8, "echo Tester takes a deep breath, then leaves down a passage.")
  DoAfter(9, "echo A ritual chamber")
  DoAfterSpecial(10, "miniepics_explain()", 12)
  DoAfter(11, "echo Once the Titan General is slain, Salkin quickly leads you back to the secret junction.")
  DoAfter(12, "echo You receive Salkin's Reward from Salkin.")
end

function miniepics_test4()
  env_area = 'titan'
  EnableTriggerGroup('me_titan', true)
  EnableTriggerGroup('me_bhits', true)
  Send("echo You receive Rune of Passage from Salkin.")
  Send("echo Tester takes a deep breath, then leaves down a passage.")
  Send("echo A small chamber")
  Send("echo An Aura of Protective Magic begins floating around Grakkr.")
  -- SendNoEcho("note read 269334")
end

function miniepics_test_boss(name, line, wc)
  env_area = 'titan'
  EnableTriggerGroup('me_titan', true)
  EnableTriggerGroup('me_bhits', true)
  AnsiNote(logoshort..' '..ColoursToANSI(logofy(wc[1])..' testing triggers started.'))
  Send("echo You receive Rune of Passage from Salkin.")
  Send("echo Tester takes a deep breath, then leaves down a passage.")
  if wc[1] == 'Durthar' then
    Send("echo At the edge of the Abyss")
    DoAfter(1, "echo Durthar fades into existence.")
    DoAfter(2, "echo Durthar exclaims 'Enough! Begone, little ants!'")
    DoAfter(3, "echo (angry) A Titan treads the knife's edge between Reality and the Void.")
    DoAfter(4, "echo (X) Durthar is fighting Saraid.")
    DoAfter(6, "echo Durthar exclaims 'Enough! Begone, little ants!'")
    DoAfter(7, "echo (X) Durthar is fighting Saraid.")
    DoAfter(8, "echo Durthar gives Durthar's Speed to Saraid.")
  elseif wc[1] == 'Lugthurg' then
    Send("echo A crystal chamber")
    DoAfter(1, "echo Lugthurg begins to observe your movements with intense focus...")
    DoAfter(2, "echo Lugthurg is trying to KILL YOU!")
    DoAfter(3, "echo Lugthurg grins at you, and his eyes seem to read you like an open book.")
    DoAfter(4, "echo Lugthurg gazes at you with a blank look, as though he has just forgotten something important.")
    DoAfter(6, "echo Lugthurg begins to observe your movements with intense focus...")
    DoAfter(7, "echo Lugthurg is fighting Saraid.")
    DoAfter(8, "echo Lugthurg grins at you, and his eyes seem to read you like an open book.")
    DoAfter(9, "echo Lugthurg gazes at you with a blank look, as though he has just forgotten something important.")
  elseif wc[1] == 'Rograg' then
    Send("echo A ritual chamber")
    DoAfter(1, "echo As an Ethereal Guardian fades away, the altar glows faintly red.")
    DoAfter(2, "echo Once the Titan General is slain, Salkin quickly leads you back to the secret junction.")
  end
end
-- #endregion
----------------------------
-- #region Trigger functions
----------------------------
function titan_shy(name, line, wc)
  debugout('titan_shy() called, env_active is '..sb(env_active))
  if env_active then
    if not env_boss then return end
    local addinfo = ''
    if env_boss.id == 'orzbuk' then
      if env_orzbuk[wc[1]] then
        addinfo = ' @r(@R( @Y'..env_orzbuk[wc[1]].pos..'.'..env_orzbuk[wc[1]].alias..' @R)@r)'
      end
    end
    writeout(logofy()..addinfo..' @x214>@Y> @x227S@x228h@x229i@Wel@x229d@x228e@x227d @Y<@x214<', 2)
  end
end

function titan_shn(name, line, wc)
  debugout('titan_shn() called, env_active is '..sb(env_active))
  if env_active then
    if not env_boss then return end
    local addinfo = ''
    if env_boss.id == 'orzbuk' then
      if env_orzbuk[wc[2]] then
        addinfo = ' @r(@R( @Y'..env_orzbuk[wc[2]].pos..'.'..env_orzbuk[wc[2]].alias..' @R)@r)'
      end
    end
    writeout(addinfo..'@x022>@x034> @x046Shield destroyed @x034<@x022< @Ythanks '..sanitize(wc[1]), 3)
  end
end

function titan_shm(name, line, wc)
  debugout('titan_shm() called, env_active is '..sb(env_active))
  if env_active then
    if not env_boss then return end
    local addinfo = ''
    if env_boss.id == 'orzbuk' then
      if env_orzbuk[wc[1]] then
        addinfo = ' @r(@R( @Y'..env_orzbuk[wc[1]].pos..'.'..env_orzbuk[wc[1]].alias..' @R)@r)'
      end
    end
    writeout(addinfo..'@x022>@x034> @x046Shield destroyed @x034<@x022<', 3)
  end
end

function titan_say(name, line, wc)
  debugout('titan_say() called, env_active is '..sb(env_active))
  if env_active then
    if not env_boss then return end
    local addinfo = ''
    if env_boss.id == 'orzbuk' then
      if env_orzbuk[wc[1]] then
        addinfo = ' @r(@R( @Y'..env_orzbuk[wc[1]].pos..'.'..env_orzbuk[wc[1]].alias..' @R)@r)'
      end
    end
    writeout(logofy()..addinfo.." @x039>@C> @x051S@x087a@x159n@Wctu@x159a@x087r@x051y @C<@x039<", 2)
  end
end

function titan_san(name, line, wc)
  debugout('titan_san() called, env_active is '..sb(env_active))
  if env_active then
    if not env_boss then return end
    debugout('titan_san wc[1] is: '..wc[1]..' and it returns '..sb(indexof(bosstitan, wc[1])))
    if indexof(bosstitan, wc[1]) then
      local addinfo = ''
      if env_boss.id == 'orzbuk' then
        if env_orzbuk[wc[1]] then
          addinfo = ' @r(@R( @Y'..env_orzbuk[wc[1]].pos..'.'..env_orzbuk[wc[1]].alias..' @R)@r)'
        end
      end
      writeout(addinfo..'@x022>@x034> @x046Sanctuary dispelled @x034<@x022<', 3)
    end
  end
end

function hit_warning(boss, always, spell)
  debugout('hit_warning() called, boss: '..boss..', always: '..always..', spell: '..spell)
    if env_active then
      if not env_boss then return end
      local addinfo = ''
      if env_boss.id == 'orzbuk' then
        if env_orzbuk[boss] then
          addinfo = ' @r(@R( @Y'..env_orzbuk[boss].pos..'.'..env_orzbuk[boss].alias..' @R)@r)'
        end
      end
      writeout(logofy()..addinfo..' @r>@R> @x214'..spell..' @R<@r< @Yhit!', 3)
    end
end

function end_boss(area, boss, player)
  debugout('end_boss() called.')
  if sanitize(string.lower(boss)) ~= env_boss.id then
    writeout("@CAn error occured - we expected "..bossinfo[env_boss.id].name.." but got "..boss.." instead. Why?", 1, 'echo')
  end
  time_duration = os.time() - time_start_boss
  line = logofy()..' @GFINISHED '..SecondsToClock(time_duration)
  if player then line = line..' @Y'..bossinfo[env_boss.id].item..'@w given to @Y'..player end
  writeout(line, 1)
  EnableTriggerGroup(bossinfo[env_boss.id].name, false)
  EnableAliasGroup('TitanBoss', false)
  writeout("@Y"..bossinfo[env_boss.id].name.." @Cis dead, turning off '@Yminiexplain@C' alias.", 4)
  env_boss = nil
  EnableAlias('miniexplain', false)
end

function start_boss(area, boss)
  debugout('start_boss() called.')
  if not env_boss then env_boss = { id = nil } end
  if sanitize(string.lower(boss)) ~= env_boss.id then env_bosscount = env_bosscount + 1 end
  time_start_boss = os.time()
  env_boss.id = sanitize(string.lower(boss))
  debugout('start_boss() set env_boss.id to: '..env_boss.id)
  EnableTriggerGroup('me_start', false)
  EnableTriggerGroup(bossinfo[env_boss.id].name, true)
  EnableAlias(bossinfo[env_boss.id].name, true)
  if env_boss.id == 'orzbuk' then fn_orzbuk('init') end
  -- if env_boss.id == 'grakkr' then EnableAlias(bossinfo[env_boss.id].name, true) end
  writeout(logofy()..' @W'..bossinfo[env_boss.id].short, 1)
  EnableAlias('miniexplain', true)
  writeout("@CYou can type now '@Yminiexplain@C' to explain @Y"..bossinfo[env_boss.id].name.." @Cto newbies in the group.", 4)
end

function start_area()
  debugout('start_area() called')
  EnableTriggerGroup('me_titan', true)
  EnableTriggerGroup('me_bhits', true)
  env_bosscount = 0
  env_boss = nil
  time_start_area = os.time()
end

function end_area()
  debugout('end_area() called')
  time_duration = os.time() - time_start_area
  line = logofy(env_area:upper())..' @GFINISHED '..SecondsToClock(time_duration)
  writeout(line, 1)
  env_bosscount = false
  env_boss = nil
end
-- #endregion
----------------------------------
-- #region Boss specific functions
----------------------------------
function fn_durthar(s)
  if not s then s = 'nil' end
  debugout('fn_durthar() called with argument: '..s)
  if env_boss.wanted == nil then env_boss.wanted = true end
  if s == 'trans' then
    writeout(logofy()..' @x094>@x208>@x226> @x226t@x227r@x228a@x229n@Wsloc@x229a@x228t@x227e@x226d @x226<@x208<@x094<', 1)
    env_boss.wanted = true
  elseif s == 'rep' and env_boss.wanted then
    writeout(logofy()..' @GFOUND @x028>@x046>@x159> @W'..gmcp('room.info.num'), 1)
    env_boss.wanted = false
  end
end

function fn_gjaka(s)
  if not s then s = 'nil' end
  debugout('fn_gjaka() called with argument: '..s)
  -- upon reentering the room, check what's my current hp
end

function fn_grakkr(s, w)
  if not s then s = 'nil' end
  debugout('fn_grakkr() called with argument: '..s)
  if s == 'init' then
    -- damage changed, output options
    -- writeout(logofy().." @c[@Y1@c]@x045Cld@c|@x083Acd@c|@x253Bsh @c[@Y2@c]@x214Holy@c|@x027Shd@c|@MMent @c[@Y3@c]@x060Neg@c|@RFire@c|@WLig @c[@Y4@c]@x141Mag@c|@x205Nrg@c|@x094Earth @c[@Y5@c]@x253Pirc@c|@x045Air@c|@x195Elec @c[@Y6@c]@x039Wtr@c|@x253Slsh@c|@x159Son", 2)
    writeout(logofy().." @c[@Y1@c]@x045Cold@c|@x083Acid@c|@x253Bash @c[@Y2@c]@x214Holy@c|@x027Shadow@c|@MMental @c[@Y3@c]@x060Negative@c|@RFire@c|@WLight @c[@Y4@c]@x141Magic@c|@x205Energy@c|@x094Earth@x094 @c[@Y5@c]@x253Pierce@c|@x045Air@c|@x195Electric @c[@Y6@c]@x039Water@c|@x253Slash@c|@x159Sonic", 2)
  elseif s == 'report' then
    -- output damage that we think is valid
    if string.match(w, "cold") or string.match(w, "acid") or string.match(w, "bash") or string.match(w, "1") then
      writeout(logofy().." @YUSE: @co-} @x045Cold @c{-o @c| @x083Acid @c| @x253Bash", 1)
    elseif string.match(w, "holy") or string.match(w, "shado?w?") or string.match(w, "menta?l?") or string.match(w, "2") then
      writeout(logofy().." @YUSE: @co-} @x214Holy @c{-o @c| @x027Shadow @c| @MMental", 1)
    elseif string.match(w, "negat?i?v?e?") or string.match(w, "fire") or string.match(w, "light?") or string.match(w, "3") then
      writeout(logofy().." @YUSE: @co-} @x060Negative @c{-o @c| @RFire @c| @WLight", 1)
    elseif string.match(w, "magic") or string.match(w, "energ?y?") or string.match(w, "earth?") or string.match(w, "4") then
      writeout(logofy().." @YUSE: @co-} @x141Magic @c{-o @c| @x205Energy @c| @x094Earth", 1)
    elseif string.match(w, "pierc?e?") or string.match(w, "air") or string.match(w, "elect?r?i?c?") or string.match(w, "shock?") or string.match(w, "5") then
      writeout(logofy().." @YUSE: @co-} @x253Pierce @c{-o @c| @x045Air @c| @x195Electric", 1)
    elseif string.match(w, "water?") or string.match(w, "slash?") or string.match(w, "sonic?") or string.match(w, "6") then
      writeout(logofy().." @YUSE: @co-} @x039Water @c{-o @c| @x253Slash @c| @x159Sonic", 1)
    else
      debugout('fn_grakkr() report argument "'..w..'" is not recognised, outputting help instead')
      writeout(logofy().." @c[@Y1@c]@x045Cold@c|@x083Acid@c|@x253Bash @c[@Y2@c]@x214Holy@c|@x027Shadow@c|@MMental @c[@Y3@c]@x060Negative@c|@RFire@c|@WLight @c[@Y4@c]@x141Magic@c|@x205Energy@c|@x094Earth@x094 @c[@Y5@c]@x253Pierce@c|@x045Air@c|@x195Electric @c[@Y6@c]@x039Water@c|@x253Slash@c|@x159Sonic", 2)
    end
  end
  -- check damage, report which to switch
  -- report aura change
end

function fn_hej(s)
  if not s then s = 'nil' end
  debugout('fn_hej() called with argument: '..s)
  -- check if anomaly is on the floor
  -- check if mobs are bunched up
end

function fn_lugthurg(s)
  if not s then s = 'nil' end
  debugout('fn_lugthurg() called with argument: '..s)
  if s == 'obs' then
    env_boss.observed = true
    writeout(logofy()..' @x094>@x208>@x226> @x226o@x227b@x228s@x229e@x229r@x228v@x227e@x226d @x226<@x208<@x094<@w', 2)
    SendNoEcho('look')
  elseif s == 'pan' then
    if env_boss.observed and env_boss.tanking then writeout(logofy()..' @x088>@x124>@x196> @x202R@x208E@x214S@x220C@YUE PLE@x220A@x214S@x208E@x202! @x196<@x124<@x088<', 1) end
  elseif s == 'end' then
    env_boss.observed = false
    writeout(logofy()..' @x159>@x046>@x028> @Gsafe @x028<@x046<@x159<', 3)
  elseif s == 'tar' then
    env_boss.tanking = true
    if env_boss.observed then writeout(logofy()..' @x094>@x208>@x226> @x226R@x228E@WSC@x228U@x226E @x226<@x208<@x094<', 1) end
  elseif s == 'saf' then
    env_boss.tanking = false
  end
end

function fn_morgak(s)
  if not s then s = 'nil' end
  debugout('fn_morgak() called with argument: '..s)
  -- catch message when runes appear, refresh minimap
  -- augment message of rune on the floor in the room
end

function fn_orzbuk(s)
  if not s then s = 'nil' end
  debugout('fn_orzbuk() called with argument: '..s)
  if s == 'init' then
    env_orzbuk = {
      ["Orzbuk's right leg"] = { alias = "gen", pos = 1, target = nil },
      ["Orzbuk's left leg"]  = { alias = "gen", pos = 2, target = nil },
      ["Orzbuk's right arm"] = { alias = "gen", pos = 3, target = nil },
      ["Orzbuk's left arm"]  = { alias = "gen", pos = 4, target = nil }
    }
  elseif s == 'catch' then
    wait.make(function()
      local x = wait.regexp(".+Exits. none.+", 10)
      if not x then debugout('fn_orzbuk(catch) - nothing received in 10 sec') return end
      local pos = 1
      local result = {}
      local tanks = {}
      local totaltanks = 0
      local me = gmcp('char.base.name')
      while true do
        local line, wc, styles = wait.match("*")
        if line == "" or not line then break end
        local a,b = string.match(line, "^.+%) (.+) is fighting (.+)%.$")
        if a and b then if env_orzbuk[a] then
          result[a] = { alias = "gen", pos = pos, target = b }
          if not tanks[b] then
            tanks[b] = 1
            totaltanks = totaltanks + 1
          else
            tanks[b] = tanks[b] + 1
          end
          pos = pos + 1
        end end
        local c = string.match(line, "^.+%) (.+) is trying to KILL YOU!$")
        if c then if env_orzbuk[c] then
          result[c] = { alias = "gen", pos = pos, target = me }
          if not tanks[me] then
            tanks[me] = 1
            totaltanks = totaltanks + 1
          else
            tanks[me] = tanks[me] + 1
          end
          pos = pos + 1
        end end
      end
      if totaltanks > 0 then
        env_orzbuk = result
        -- @YTANKS: @r[@G1@r]@wDomen, @r[@Y2@r]@wKalista, @r[@R4@r]@wBlueFeather
        local output = " @YTANKS: "
        local separator = ", "
        local colors = {"@G", "@Y", "@R", "@R"}
        local i = 1
        for k,v in pairs(tanks) do
          if i == totaltanks then separator = "" end
          output = output.."@r["..colors[v]..v.."@r]@w"..k..separator
          i = i + 1
        end
        writeout(logofy()..output, 2)
      end
    end)
  elseif s == 'report' then
    wait.make(function()
      SendNoEcho('study')
      local x = wait.match("You quickly evaluate the health of all present.", 10)
      if not x then debugout('fn_orzbuk(catch) - nothing received in 10 sec') return end
      local result = {}
      local pos = 1
      while true do
        local line, wc, styles = wait.match("*")
        if line == "" or not line then break end -- escape while loop condition
        for i,v in ipairs(study_patterns) do
          if v.val ~= "me" then
            local p = string.match(line, v.match)
            if p then
              if env_orzbuk[p] then
                result[p] = { pos = pos, hp = v.avg, alias = env_orzbuk[p].alias, target = env_orzbuk[p].target }
                pos = pos + 1
              end
            end
          end
        end
      end
      -- @YSTUDY: @w1.general@r[@Y100%@r] @w2.general@r[@Y90%@r] @w3.general@r[@Y97%@r]
      local output = " @YSTUDY: "
      local separator = " "
      pos = pos - 1 -- rewind one back
      local i = 1
      for k,v in pairs(result) do
        if i == pos then separator = "" end
        output = output.."@w"..v.pos.."."..v.alias.."@r[@Y"..v.hp.."%@r]"..separator
        i = i + 1
      end
      writeout(logofy()..output, 1)
    end)
  end
end

function fn_rograg(s)
  if not s then s = 'nil' end
  debugout('fn_rograg() called with argument: '..s)
  writeout(logofy()..' @Rred @waltar @GFOUND @x028>@x046>@x159> @W'..gmcp('room.info.num'), 1)
end
-- #endregion
-------------------------
-- #region Zone awareness
-------------------------
function OnPluginBroadcast(msg, id, name, text)
  if text == 'char.base' then
    Send_GMCP_Packet('request area')
    Send_GMCP_Packet('request room')
    debugout('We have reconnected, issue area/room request')
  end
  if env_active then
    -- if name ~= 'Aardwolf_Soundpack' and name ~= 'Galabans_Moons' and name ~= 'Aardwolf_GMCP_Mapper' and name ~= 'WinkleGold_Search_Destroy' and name ~= 'WinkleGold_Mapper_Extender' then
    --   debugout('msg: '..msg..', id: '..id..', name: '..name..', text: '..text) -- Ignore known broadcasts, give unknown ones
    -- end
    -- debugout(name..': '..text)
    if name == 'GMCP_handler' then
      -- Figuring out what gmcp contains for char.* and for room.*
      -- if string.match(text,'char.') then
      --   debugout(text..' received! This is what we have about it:')
      --   debugout(dump(gmcp(text)))
      -- elseif string.match(text,'room.') then
      --   debugout(text..' received! This is what we have about it:')
      --   debugout(dump(gmcp(text)))
      -- end
      if text == 'room.area' then
        -- debugout('room.area broadcast heard.')
        if gmcp('room.area.id') == 'titan' then
          if env_area ~= 'titan' then
            if env_area == 'terra' then
              writeout(logofy(string.upper(env_area))..' @Warea left.', 4)
              EnableTriggerGroup('me_terra', false)
              debugout('me_terra trigger group OFF.')
              EnableTriggerGroup('me_bhits', false)
              debugout('me_bhits trigger group OFF.')
            end
            env_area = 'titan'
            EnableTriggerGroup('me_titan', true)
            debugout('me_titan trigger group ON.')
            EnableTriggerGroup('me_bhits', true)
            debugout('me_bhits trigger group ON.')
            SaveState()
            writeout(logofy(string.upper(env_area))..' @Warea entered. Triggers are [@GON@W]', 4)
          end
        elseif gmcp('room.area.id') == 'terra' then
          if env_area ~= 'terra' then
            if env_area == 'titan' then
              writeout(logofy(string.upper(env_area))..' @Warea left.', 4)
              EnableTriggerGroup('me_titan', false)
              debugout('me_titan trigger group OFF.')
              EnableTriggerGroup('me_bhits', false)
              debugout('me_bhits trigger group OFF.')
            end
            env_area = 'terra'
            EnableTriggerGroup('me_terra', true)
            debugout('me_terra trigger group ON.')
            EnableTriggerGroup('me_bhits', true)
            debugout('me_bhits trigger group ON.')
          SaveState()
            writeout(logofy(string.upper(env_area))..' @Warea entered. Triggers are [@GON@W]', 4)
          end
        else
          if env_area == 'titan' or env_area == 'terra' then
            writeout(logofy(string.upper(env_area))..' @Warea left.', 4 , 'echo')
            env_area = 'out'
            EnableTriggerGroup('me_titan', false)
            debugout('me_titan trigger group OFF.')
            EnableTriggerGroup('me_terra', false)
            debugout('me_terra trigger group OFF.')
            EnableTriggerGroup('me_bhits', false)
            debugout('me_bhits trigger group OFF.')
            SaveState()
          end
        end
      end
    end
  end
end
-- #endregion
---------------------------
-- #region Helpers - output
---------------------------
function miniepics_help()
  AnsiNote(ColoursToANSI('@C{-o @Y----------------@C[  ')..logo..ColoursToANSI('  @C]@Y---------------- @Co-}@w'))
  AnsiNote()
  AnsiNote(ColoursToANSI('  @CCommands:'))
  if env_active then
    AnsiNote(ColoursToANSI('    @Yminiepics         @w- switch plugin ON / OFF       Now: [@G ON @w]'))
  else
    AnsiNote(ColoursToANSI('    @Yminiepics         @w- switch plugin ON / OFF       Now: [@R OFF @w]'))
  end
  if env_commlog then
    AnsiNote(ColoursToANSI('    @Yminiepics commlog @w- redirect echo to commlog     Now: [@G ON @w]'))
  else
    AnsiNote(ColoursToANSI('    @Yminiepics commlog @w- redirect echo to commlog     Now: [@R OFF @w]'))
  end
  AnsiNote(ColoursToANSI('    @Yminiepics help    @w- this screen'))
  if env_commlog then
    AnsiNote(ColoursToANSI('    @Yminiepics gt      @w- set output to gt, say, echo & commlog'))
    AnsiNote(ColoursToANSI('    @Yminiepics say     @w- set output to say, echo & commlog'))
    AnsiNote(ColoursToANSI('    @Yminiepics echo    @w- set output to echo & commlog'))
  else
    AnsiNote(ColoursToANSI('    @Yminiepics gt      @w- set output to gt, say & echo'))
    AnsiNote(ColoursToANSI('    @Yminiepics say     @w- set output to say & echo'))
    AnsiNote(ColoursToANSI('    @Yminiepics echo    @w- set output to echo'))
  end
  -- AnsiNote(ColoursToANSI('    @Yminiepics debug   @w- toggle debug info'))
  AnsiNote()
  AnsiNote(ColoursToANSI('  @CVerbosity level:'))
  if env_verbosity == 1 then line_channame = '[@Y '..env_verbosity_name[1]..' @w]' else line_channame = '[@y '..env_verbosity_name[1]..' @w]' end
  AnsiNote(ColoursToANSI('    @Yminiepics v1      @w- '..line_channame..' - output to: [ @Y'..env_chan..'@w ]'))
  
  if env_verbosity == 2 then line_channame = '[@Y '..env_verbosity_name[2]..' @w]' else if env_verbosity > 2 then line_channame = '[@y '..env_verbosity_name[2]..' @w]' else line_channame = '[ '..env_verbosity_name[2]..' ]' end end
  if env_verbosity >= 2 then if env_chan == 'echo' then line_outputto = 'output to: [ @Yecho@w ]' else line_outputto = 'output to: [ @Ysay@w ]' end else line_outputto = 'not outputting' end
  AnsiNote(ColoursToANSI('    @Yminiepics v2      @w- '..line_channame..' - '..line_outputto))

  if env_verbosity == 3 then line_channame = '[@Y '..env_verbosity_name[3]..' @w]' else if env_verbosity > 3 then line_channame = '[@y '..env_verbosity_name[3]..' @w]' else line_channame = '[ '..env_verbosity_name[3]..' ]' end end
  if env_verbosity >= 3 then if env_chan == 'echo' then line_outputto = 'output to: [ @Yecho@w ]' else line_outputto = 'output to: [ @Ysay@w ]' end else line_outputto = 'not outputting' end
  AnsiNote(ColoursToANSI('    @Yminiepics v3      @w- '..line_channame..' - '..line_outputto))
  
  if env_verbosity == 4 then line_channame = '[@Y '..env_verbosity_name[4]..' @w]' else line_channame = '[ '..env_verbosity_name[4]..' ]' end
  if env_verbosity >= 4 then line_outputto = 'output to: [ @Yecho@w ]' else line_outputto = 'not outputting' end
  AnsiNote(ColoursToANSI('    @Yminiepics v4      @w- '..line_channame..' - '..line_outputto))

  AnsiNote()
  AnsiNote(ColoursToANSI('  @CUsage:'))
  AnsiNote(ColoursToANSI('    @wPlugin will autodetect your current zone and activate'))
  AnsiNote(ColoursToANSI('    @wrequired triggers that report to [@Y '..env_chan..' @w] channel.'))
  AnsiNote(ColoursToANSI('    @wKeep in mind that echo & commlog are instant, while say & gt'))
  AnsiNote(ColoursToANSI('    @ware prone to lag (especially if you spam commands).'))
  AnsiNote()
  AnsiNote(ColoursToANSI('@C{-o @Y---------------------------------------------------------------- @Co-}@w'))
end

function miniepics_explain()
  if env_boss.id and env_active then
    writeout('@W'..bossinfo[env_boss.id].long, 1)
  end
end

function writeout(s,i,c)
  -- s = message (string), i = verbosity level (num), c = channel overwrite (string)
  -- i == 1 - crucial    - echo, say, gt
  -- i == 2 - important  - echo, say
  -- i == 3 - normal     - echo, say
  -- i == 4 - spammy     - echo
  if i > env_verbosity then return end
  if env_commlog then CallPlugin("b555825a4a5700c35fa80780", "storeFromOutside", AnsiToColours(logoshort)..' '..s, 1, true) end

  if i == 1 then
    targetchannel = env_chan
  elseif i == 2 or i == 3 then
    if env_chan == 'gt' then targetchannel = 'say' else targetchannel = env_chan end
  else
    targetchannel = 'echo'
  end

  if c ~= nil then targetchannel = c end
  if targetchannel == 'echo' then AnsiNote(logoshort..' '..ColoursToANSI(s)) end
  if targetchannel == 'gt' then SendNoEcho('gt '..s..'@Y') end
  if targetchannel == 'say' then SendNoEcho('say '..s..'@C') end
end

function logofy(s)
  -- add logo for hook, baal, boot
  if env_boss and env_boss.id and not s then
    return '@x37o@x44-@C} @G[@Y'..env_bosscount..'@G]@Y'..bossinfo[env_boss.id].name..' @C{@x44-@x37o'
  elseif s then
    return '@x37o@x44-@C} @Y'..s..' @C{@x44-@x37o'
  else
    return '@x37o@x44-@C} @YSomeone @C{@x44-@x37o'
  end
end

function debugout(e)
  if env_debug then
    AnsiNote(logoshort..ColoursToANSI(' @Y[@ydebug@Y] @W'..e))
  end
end

function miniepics_badcommand()
  AnsiNote(logoshort..ColoursToANSI('@R Unknown command.@w Type @Yminiepics help @wfor commands and usage info.'))
end

function OnPluginInstall()
  -- TODO - add check if we needed to reload during a run
  AnsiNote(logo..ColoursToANSI('@w type @Yminiepics help @wfor commands and usage info.'))
end

function OnPluginSaveState()
  -- this will run when SaveState() is called or if mush is closing etc
  SetVariable('env_area', env_area)
  SetVariable('env_chan', env_chan)
  SetVariable('env_active', sb(env_active))
  SetVariable('env_debug', sb(env_debug))
  SetVariable('env_verbosity', tostring(env_verbosity))
  SetVariable('env_commlog', sb(env_commlog))
end
-- #endregion

]]>
</script> 

</muclient>
