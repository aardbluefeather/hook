<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<muclient>
<plugin
   name="HooK_MiniEpics"
   author="BlueFeather"
   id="2a0221da142c2505699c5adb"
   language="Lua"
   purpose="Mini epic (Titan/Terra) triggers and reports"
   save_state="y"
   date_written="2019-06-26 21:47:01"
   requires="5.06"
   version="0.5"
   >
<description trim="y">
<![CDATA[
A collection of triggers for use in Titan and Terra miniepics - to make life there easier.
]]>
</description>

</plugin>


<!--  Get our standard constants -->

<include name="constants.lua"/>

<!--  Triggers  -->

<triggers>
  <!-- Boss hits -->
  <trigger match="^(.+) looks very uncomfortable\.$"                               regexp="y" enabled="n" group="me_bhits" sequence="99" send_to="12"><send>hit_warning("%1",'y','Curse')</send></trigger>
  <trigger match="^You ridicule (.+) about \w+ childhood\.$"                       regexp="y" enabled="n" group="me_bhits" sequence="99" send_to="12"><send>hit_warning("%1",'n','Ego Whip')</send></trigger>
  <trigger match="^(.+?)'?s? ego is crushed by \w+!$"                              regexp="y" enabled="n" group="me_bhits" sequence="99" send_to="12"><send>hit_warning("%1",'n','Ego Whip')</send></trigger>
  <trigger match="^(.+) looks very ill\.$"                                         regexp="y" enabled="n" group="me_bhits" sequence="99" send_to="12"><send>hit_warning("%1",'n','Poison')</send></trigger>
  <trigger match="^You mark (.+) with a Rune of IX!$"                              regexp="y" enabled="n" group="me_bhits" sequence="99" send_to="12"><send>hit_warning("%1",'y','Rune of IX')</send></trigger>
  <trigger match="^(.+?)'?s? armor softens\.$"                                     regexp="y" enabled="n" group="me_bhits" sequence="99" send_to="12"><send>hit_warning("%1",'n','Soften')</send></trigger>
  <trigger match="^(.+) looks tired and weak\.$"                                   regexp="y" enabled="n" group="me_bhits" sequence="99" send_to="12"><send>hit_warning("%1",'n','Weaken')</send></trigger>
  <trigger match="^(.+) looks unwell\.$"                                           regexp="y" enabled="n" group="me_bhits" sequence="99" send_to="12"><send>hit_warning("%1",'n','Disease')</send></trigger>
  <trigger match="^(.+?)'?s? flesh is ripped from \w+ body\.$"                     regexp="y" enabled="n" group="me_bhits" sequence="99" send_to="12"><send>hit_warning("%1",'n','Raw Flesh')</send></trigger>
  <trigger match="^(.+) looks unwell\.$"                                           regexp="y" enabled="n" group="me_bhits" sequence="99" send_to="12"><send>hit_warning("%1",'n','Disease')</send></trigger>
  <trigger match="^(.+) appears to falter. Your victim is in serious trouble!$"    regexp="y" enabled="n" group="me_bhits" sequence="99" send_to="12"><send>hit_warning("%1",'n','Hydra Blood')</send></trigger>
  <trigger match="^(.+) appears pale and weak\.$"                                  regexp="y" enabled="n" group="me_bhits" sequence="99" send_to="12"><send>hit_warning("%1",'n','Hydra Blood')</send></trigger>
  <trigger match="^Your acidic venom burns away (.+?)'?s? armor\.$"                regexp="y" enabled="n" group="me_bhits" sequence="99" send_to="12"><send>hit_warning("%1",'n','Raven Scourge')</send></trigger>
  <trigger match="^(.+) appears much weaker and extremely vulnerable\.$"           regexp="y" enabled="n" group="me_bhits" sequence="99" send_to="12"><send>hit_warning("%1",'n','Green Death')</send></trigger>
  <trigger match="^(.+) appears extremely vulnerable as the mist surrounds \w+\.$" regexp="y" enabled="n" group="me_bhits" sequence="99" send_to="12"><send>hit_warning("%1",'n','Green Death')</send></trigger>
  <trigger match="^(.+) turns pale and appears weakened\.$"                        regexp="y" enabled="n" group="me_bhits" sequence="99" send_to="12"><send>hit_warning("%1",'y','Kobold Spray')</send></trigger>
  <trigger match="^(.+?)'?s? body starts to weaken\.$"                             regexp="y" enabled="n" group="me_bhits" sequence="99" send_to="12"><send>hit_warning("%1",'n','Hex of Entropy')</send></trigger>
  <!-- TITAN -->
  <!-- Boss start and boss end -->
  <trigger match="^You receive Rune of Passage from Salkin\.$"            regexp="y" enabled="n" group="me_titan" sequence="99" script="start_area"></trigger>
  <trigger match="^You receive Salkin's Reward from Salkin\.$"            regexp="y" enabled="n" group="me_titan" sequence="99" script="end_area"></trigger>
  <trigger match="^.+ takes a deep breath, then leaves down a passage\.$" regexp="y" enabled="n" group="me_titan" sequence="99" send_to="12"><send>EnableTriggerGroup('me_start', true)</send></trigger>

  <trigger match="^At the edge of the Abyss$" regexp="y" enabled="n" group="me_start" sequence="99" send_to="12"><send>start_boss('titan','Durthar')</send></trigger>
  <trigger match="^Shattered reality$"        regexp="y" enabled="n" group="me_start" sequence="99" send_to="12"><send>start_boss('titan','Gjaka')</send></trigger>
  <trigger match="^A small chamber$"          regexp="y" enabled="n" group="me_start" sequence="99" send_to="12"><send>start_boss('titan','Grakkr')</send></trigger>
  <trigger match="^A vast plain$"             regexp="y" enabled="n" group="me_start" sequence="99" send_to="12"><send>start_boss('titan','Hej')</send></trigger>
  <trigger match="^A crystal chamber$"        regexp="y" enabled="n" group="me_start" sequence="99" send_to="12"><send>start_boss('titan','Lugthurg')</send></trigger>
  <trigger match="^A large arena$"            regexp="y" enabled="n" group="me_start" sequence="99" send_to="12"><send>start_boss('titan','Morgak')</send></trigger>
  <trigger match="^A crystal seal$"           regexp="y" enabled="n" group="me_start" sequence="99" send_to="12"><send>start_boss('titan','Orzbuk')</send></trigger>
  <trigger match="^A ritual chamber$"         regexp="y" enabled="n" group="me_start" sequence="99" send_to="12"><send>start_boss('titan','Rograg')</send></trigger>
  
  <trigger match="^Durthar gives Durthar's Speed to (.+)\.$"     regexp="y" enabled="n" group="Durthar"  sequence="99" send_to="12"><send>end_boss('titan','Durthar',"%1")</send></trigger>
  <trigger match="^Gjaka gives Gjaka's Burden to (.+)\.$"        regexp="y" enabled="n" group="Gjaka"    sequence="99" send_to="12"><send>end_boss('titan','Gjaka',"%1")</send></trigger>
  <trigger match="^Grakkr gives Grakkr's Leadership to (.+)\.$"  regexp="y" enabled="n" group="Grakkr"   sequence="99" send_to="12"><send>end_boss('titan','Grakkr',"%1")</send></trigger>
  <trigger match="^.+ Hej gives Hej's Compendium to (.+)\.$"     regexp="y" enabled="n" group="Hej"      sequence="99" send_to="12"><send>end_boss('titan','Hej',"%1")</send></trigger>
  <trigger match="^Lugthurg gives Lugthurg's Bones to (.+)\.$"   regexp="y" enabled="n" group="Lugthurg" sequence="99" send_to="12"><send>end_boss('titan','Lugthurg',"%1")</send></trigger>
  <trigger match="^Morgak gives Morgak's Silence to (.+)\.$"     regexp="y" enabled="n" group="Morgak"   sequence="99" send_to="12"><send>end_boss('titan','Morgak',"%1")</send></trigger>
  <trigger match="^Orzbuk's .+ gives Orzbuk's Vision to (.+)\.$" regexp="y" enabled="n" group="Orzbuk"   sequence="99" send_to="12"><send>end_boss('titan','Orzbuk',"%1")</send></trigger>
  <trigger match="^Rograg gives you Rograg's Greaves\.$"         regexp="y" enabled="n" group="Rograg"   sequence="99" send_to="12"><send>end_boss('titan','Rograg','me')</send></trigger>
  <trigger match="^Once the Titan General is slain, Salkin quickly leads you back to the secret junction\.$" regexp="y" enabled="n" group="Rograg" sequence="99" send_to="12"><send>end_boss('titan','Rograg','tank')</send></trigger>

  <trigger match="^.+ gives Durthar's Speed to Salkin\.$"        regexp="y" enabled="n" group="Durthar"  sequence="99" send_to="12"><send>end_boss('titan','Durthar')</send></trigger>
  <trigger match="^.+ gives Gjaka's Burden to Salkin\.$"         regexp="y" enabled="n" group="Gjaka"    sequence="99" send_to="12"><send>end_boss('titan','Gjaka')</send></trigger>
  <trigger match="^.+ gives Grakkr's Leadership to Salkin\.$"    regexp="y" enabled="n" group="Grakkr"   sequence="99" send_to="12"><send>end_boss('titan','Grakkr')</send></trigger>
  <trigger match="^.+ gives Hej's Compendium to Salkin\.$"       regexp="y" enabled="n" group="Hej"      sequence="99" send_to="12"><send>end_boss('titan','Hej')</send></trigger>
  <trigger match="^.+ gives Lugthurg's Bones to Salkin\.$"       regexp="y" enabled="n" group="Lugthurg" sequence="99" send_to="12"><send>end_boss('titan','Lugthurg')</send></trigger>
  <trigger match="^.+ gives Morgak's Silence to Salkin\.$"       regexp="y" enabled="n" group="Morgak"   sequence="99" send_to="12"><send>end_boss('titan','Morgak')</send></trigger>
  <trigger match="^.+ gives Orzbuk's Vision to Salkin\.$"        regexp="y" enabled="n" group="Orzbuk"   sequence="99" send_to="12"><send>end_boss('titan','Orzbuk')</send></trigger>
  <trigger match="^.+ gives Rograg's Greaves to Salkin\.$"       regexp="y" enabled="n" group="Rograg"   sequence="99" send_to="12"><send>end_boss('titan','Rograg')</send></trigger>

  <!-- Shield and sanc, common Boss behaviour -->
  <trigger match="^(.+) wears a Mighty Shield as a shield\.$"                      regexp="y" enabled="n" group="me_titan" keep_evaluating="y" sequence="99" script="titan_shy"></trigger>
  <trigger match="^With awesome force (.+) cleaves (.+?)'?s? shield in half!$"     regexp="y" enabled="n" group="me_titan" keep_evaluating="y" sequence="99" script="titan_shn"></trigger>
  <trigger match="^(.+) quaffs a potion of Sanctuary.$"                            regexp="y" enabled="n" group="me_titan" keep_evaluating="y" sequence="99" script="titan_say"></trigger>
  <trigger match="^The white aura around (.+?)'?s? body vanishes.$"                regexp="y" enabled="n" group="me_titan" keep_evaluating="y" sequence="99" script="titan_san"></trigger>
  <!-- TERRA -->
  <trigger match="^The white aura around (.+?)'?s? body vanishes.$"                regexp="y" enabled="n" group="me_terra" keep_evaluating="y" sequence="99" script=""></trigger>
</triggers>

<!--  Aliases  -->

<aliases>
  <alias match="^miniepi?c?s?$"               regexp="y" enabled="y" script="miniepics_toggle"></alias>
  <alias match="^miniepi?c?s? (gt|say|echo)$" regexp="y" enabled="y" script="miniepics_channel"></alias>
  <alias match="^miniepi?c?s? commlog$"       regexp="y" enabled="y" script="miniepics_commlog"></alias>
  <alias match="^miniepi?c?s? help$"          regexp="y" enabled="y" script="miniepics_help"></alias>
  <alias match="^miniepi?c?s? test$"          regexp="y" enabled="y" script="miniepics_test"></alias>
  <alias match="^miniepi?c?s? test2$"         regexp="y" enabled="y" script="miniepics_test2"></alias>
  <alias match="^miniepi?c?s? test3$"         regexp="y" enabled="y" script="miniepics_test3"></alias>
  <alias match="^miniepi?c?s? debug$"         regexp="y" enabled="y" script="miniepics_debug"></alias>
  <alias match="^miniexplain$" name="miniexplain" regexp="y" enabled="n" script="miniepics_explain"></alias>
</aliases>

<!--  Script  -->

<script>
<![CDATA[
-------------------
-- Helper functions
-------------------
function sb(b) if b then return 'true' else return 'false' end end
function gb(s) if s == 'true' then return true else return false end end
function PadString(str, len, char) if char == nil then char = ' ' end return string.rep(char, len - #str) .. str end
function sanitize(s) return s:gsub('[%p%c]','') end
function indexof(t, s) for k, v in ipairs(t) do if v == s then return true end end return false end
function AnsiNoteN(n, s) for i = n, 1, -1 do AnsiNote(s) end end
function dump(o)
  if type(o) == 'table' then
     local s = '{ '
     for k,v in pairs(o) do
        if type(k) ~= 'number' then k = '"'..k..'"' end
        s = s .. '['..k..'] = ' .. dump(v) .. ','
     end
     return s .. '} '
  else
     return tostring(o)
  end
end
function SecondsToClock(s)
  local s = tonumber(s)
  if s <= 0 then return ClockFormat(0,0,0);
  else h = math.floor(s/3600); m = math.floor(s/60 - (h*60)); s = math.floor(s - h*3600 - m*60); return ClockFormat(h,m,s)
  end
end
function ClockFormat(h,m,s) return '@W'..string.format('%02.f', h)..'@wh @W'..string.format('%02.f', m)..'@wm @W'..string.format('%02.f', s)..'@ws' end

-----------------
-- Default values
-----------------
require "gmcphelper"
require "serialize"
dofile(GetPluginInfo(GetPluginID(),20).."aardwolf_colors.lua")
local logo = ColoursToANSI('@Co-}@YHooK@C{-o  @x051M@x044i@x037n@x030i@x051E@x044p@x037i@x030cs @cv@C0@c.@C5')
local logoshort = ColoursToANSI('@Y[@x051M@x044i@x037n@x030i@x051E@x044p@x037i@x030cs@Y]')
local env_active = gb(GetVariable('env_active')) or true
local env_debug = gb(GetVariable('env_debug')) or false
local env_commlog = gb(GetVariable('env_commlog')) or false
local env_area = GetVariable('env_area') or 'out'
local env_chan = GetVariable('env_chan') or 'echo'
local bosstitan = { "Grakkr", "Hej", "Orzbuk", "Lugthurg", "Gjaka", "Morgak", "Durthar", "Rograg" }
local bossterra = { "Kjare", "Skeligh", "Yqath", "Vortath", "Salkin", "Nysil", "Yrelth", "Ksajus" }
local bossinfo = {
  durthar = {
    name = 'Durthar',
    item = "Durthar's Speed",
    short = '@wthe "@Gfind me in the maze@w" boss.',
    long = "This boss fight involves a randomized maze that the boss randomly transfers around in. The random transfer happen when Durthar reaches 80/60/40/20/10% HP. As the boss fight goes on, tendrils are randomly populated through the maze. These tendrils are not killable, but they can be tamed. The best practice is to retreat, flee or mist form. Good practice is to place pets close to boss for easier navigation."
  },
  gjaka = {
    name = 'Gjaka',
    item = "Gjaka's Burden",
    short = '@wthe "@Gfight him with low hp@w" boss.',
    long = "This boss will switch his HP% with a random member in the group at 80/60/40/20%. If the random group member has a higher HP% than Grakkr, Grakkr will take their HP% as his own. The typical strategy for this boss is to have one person tank Grakkr. The rest of the group will turn autoassist off, flee off Grakkr, and keep moving east until their HP% is around 20%. After that, just tank and spank."
  },
  grakkr = {
    name = 'Grakkr',
    item = "Grakkr's Leadership",
    short = '@wthe "@Gchange your damtype@w" boss.',
    long = "The boss wears a special aura that changes up his resistances every so often. You will want to switch through the different damage types to find his vulnerabilities. Damage groups are: [Cold-Acid-Bash], [Holy-Shadow-Mental], [Negative-Fire-Light], [Magic-Energy-Earth], [Pierce-Air-Electric], [Water-Slash-Sonic]"
  },
  hej = {
    name = 'Hej',
    item = "Hej's Compendium",
    short = '@wthe "@Gbody, mind and soul@w" boss.',
    long = "This boss is split into three mobs: body, mind, and soul. During this boss fight, you will want to keep each of them fully webbed and kill them at about the same time. The three mobs will try to unite in a room. If this happens, you will want to find an 'anomaly' on the floor and hand it to one of the mobs to split them apart. When the mobs in a room together, their damage is multiplied and makes it hard to withstand the damage."
  },
  lugthurg = {
    name = 'Lugthurg',
    item = "Lugthurg's Bones",
    short = '@wthe "@Gobserving@w" boss.',
    long = "Throughout the fight, the boss will randomly observe individuals. If the observed individuals are tanking Lugthurg at the time of his random slicings, they will take massive amounts of damage. Only observed individual will see that the boss is observing them, so they will need to call it out, so they can be rescued."
  },
  morgak = {
    name = 'Morgak',
    item = "Morgak's Silence",
    short = '@wthe "@Gexploding runes@w" boss.',
    long = "This boss will randomly place runes inside of his 3x3 room dungeon. If the runes are visible on the map, you will want to avoid those rooms or they will explode on entry. If the runes do not appear on map, you can run through the room until you find one without a rune. The object is to dodge the runes and kill Morgak after dodging the runes."
  },
  orzbuk = {
    name = 'Orzbuk',
    item = "Orzbuk's Vision",
    short = '@wthe "@G4 piece@w" boss.',
    long = "This boss is a total of 4 mobs: right leg, left leg, right arm, left arm. The group will want to quickly cast 'reverse align' on each of the mobs to reduce the damage from the mobs. The best strategy is to split up tanking of each mob amongst the group. After all the mobs have dropped below 90/80/70/60/50/40/30/20/10%, the group will get their HP restored."
  },
  rograg = {
    name = 'Rograg',
    item = "Rograg's Greaves",
    short = '@wthe "@Galtar@w" boss.',
    long = "Main tank will 'nod salkin' to get transferred to Rograg. The rest will kill the guardians until they find red color of the altar. Then the titan in the center will be pushed to that altar, killed, and the heart sacrificed. Another titan will appear in his place (not in center). Keep killing the titans and sacrificing the heart."
  }
}

------------------
-- Miniepics alias
------------------
function miniepics_toggle()
  if env_active then
    env_active = false
    SaveState()
    EnableTriggerGroup('me_titan', false) debugout('me_titan OFF')
    EnableTriggerGroup('me_terra', false) debugout('me_terra OFF')
    EnableTriggerGroup('me_bhits', false) debugout('me_bhits OFF')
    noteout('@w miniepic triggers turned @ROFF')
  else
    env_active = true
    SaveState()
    if gmcp('room.info.zone') == 'titan' then EnableTriggerGroup('me_titan', true) EnableTriggerGroup('me_bhits', true) debugout('me_titan ON') debugout('me_bhits ON') end
    if gmcp('room.info.zone') == 'terra' then EnableTriggerGroup('me_terra', true) EnableTriggerGroup('me_bhits', true) debugout('me_terra ON') debugout('me_bhits ON') end
    noteout('@w miniepic triggers turned @GON')
  end
end

function miniepics_commlog()
  if env_commlog then
    env_commlog = false
    SaveState()
    noteout('@w communication log integration is [@ROFF@w]')
  else
    env_commlog = true
    SaveState()
    noteout('@w communication log integration is [@GON@w]')
  end
end

function miniepics_debug()
  if env_debug then
    env_debug = false
    SaveState()
    noteout('@w miniepic debugging turned @ROFF')
  else
    env_debug = true
    SaveState()
    noteout('@w miniepic debugging turned @GON')
  end
end

function miniepics_channel(name, line, wc)
  env_chan = wc[1]
  SaveState()
  noteout('@w miniepic channel set to @Y'..env_chan)
end

function miniepics_test()
  EnableTriggerGroup('me_titan', true)
  EnableTriggerGroup('me_bhits', true)
  SendNoEcho("echo With awesome force Pumpkin cleaves Grakkr's shield in half!")
  SendNoEcho("echo Grakkr wears a Mighty Shield as a shield.")
  SendNoEcho("echo Grakkr quaffs a potion of Sanctuary.")
  SendNoEcho("echo The white aura around Grakkr's body vanishes.")
end

function miniepics_test2()
  EnableTriggerGroup('me_titan', true)
  EnableTriggerGroup('me_bhits', true)
  SendNoEcho("echo Grakkr looks very uncomfortable.")
  SendNoEcho("echo Grakkr's ego is crushed by Tymme!")
  SendNoEcho("echo Grakkr looks tired and weak.")
  SendNoEcho("echo Grakkr appears extremely vulnerable as the mist surrounds it.")
end

function miniepics_test3()
  env_area = 'titan'
  EnableTriggerGroup('me_titan', true)
  SendNoEcho("echo You receive Rune of Passage from Salkin.")
  SendNoEcho("echo Tester takes a deep breath, then leaves down a passage.")
  SendNoEcho("echo Shattered reality")
  DoAfterSpecial(2, "miniepics_explain()", 12)
  DoAfter(3, "echo RedFeather gives Gjaka's Burden to Salkin.")
  DoAfter(4, "echo Tester takes a deep breath, then leaves down a passage.")
  DoAfter(5, "echo A crystal chamber")
  DoAfterSpecial(6, "miniepics_explain()", 12)
  DoAfter(7, "echo Lugthurg gives Lugthurg's Bones to BlueFeather.")
  DoAfter(8, "echo Tester takes a deep breath, then leaves down a passage.")
  DoAfter(9, "echo A ritual chamber")
  DoAfterSpecial(10, "miniepics_explain()", 12)
  DoAfter(11, "echo Once the Titan General is slain, Salkin quickly leads you back to the secret junction.")
  DoAfter(12, "echo You receive Salkin's Reward from Salkin.")
end
--------------------
-- Trigger functions
--------------------
function titan_shy(name, line, wc)
  debugout('titan_shy function called, env_active is '..sb(env_active))
  if env_active then
    line = ' @R'..sanitize(wc[1])..' @Co-}@YShielded!@C{-o'
    reportout(line)
  end
end

function titan_shn(name, line, wc)
  debugout('titan_shn function called, env_active is '..sb(env_active))
  if env_active then
    line = ' @G'..sanitize(wc[2])..' @Co-}@GShield destroyed!@C{-o @Yby '..sanitize(wc[1])
    reportout(line)
  end
end

function titan_say(name, line, wc)
  debugout('titan_say function called, env_active is '..sb(env_active))
  if env_active then
    line = ' @R'..sanitize(wc[1]).." @Co-}@WSanc'ed!@C{-o"
    reportout(line)
  end
end

function titan_san(name, line, wc)
  debugout('titan_san function called, env_active is '..sb(env_active))
  if env_active then
    debugout('titan_san wc[1] is: '..wc[1]..' and it returns '..sb(indexof(bosstitan, wc[1])))
    if indexof(bosstitan, wc[1]) then
      line = ' @G'..sanitize(wc[1])..' @Co-}@GDispelled sanctuary!@C{-o'
      reportout(line)
    end
  end
end

function hit_warning(boss, always, spell)
  debugout('hit_warning function called, boss: '..boss..', always: '..always..', spell: '..spell)
    if env_active then
      if indexof(bosstitan, boss) or indexof(bossterra, boss) or boss:lower() == 'someone' then
        line = ' @Y'..sanitize(boss)..' @Co-}@W'..spell..'@C{-o @Yhit!'
        reportout(line)
      end
    end
end

function end_boss(area, boss, player)
  if sanitize(string.lower(boss)) ~= env_boss then
    noteout("@C An error occured - we expected "..bossinfo[env_boss].name.." but got "..boss.." instead. Why?")
  end
  time_duration = os.time() - time_start_boss
  line = ' @Co-}@Y'..bossinfo[env_boss].name..'@C{-o  @GFINISHED: '..SecondsToClock(time_duration)
  if player then line = line..'@w ... @C'..bossinfo[env_boss].item..'@w given to @Y'..player end
  reportout(line)
  EnableTriggerGroup(bossinfo[env_boss].name, false)
  noteout("@C "..bossinfo[env_boss].name.." is dead, turning off '@Yminiexplain@C' alias.")
  env_boss = false
  EnableAlias('miniexplain', false)
end

function start_boss(area, boss)
  if sanitize(string.lower(boss)) ~= env_boss then env_bosscount = env_bosscount + 1 end
  time_start_boss = os.time()
  env_boss = sanitize(string.lower(boss))
  EnableTriggerGroup('me_start', false)
  EnableTriggerGroup(bossinfo[env_boss].name, true)
  line = ' @Co-}@Y'..bossinfo[env_boss].name..'@C{-o @w[@Y'..env_bosscount..'@w] '..bossinfo[env_boss].short
  reportout(line)
  EnableAlias('miniexplain', true)
  noteout("@C You can type now '@Yminiexplain@C' to explain "..bossinfo[env_boss].name.." to newbies in the group.")
end

function start_area()
  env_bosscount = 0
  time_start_area = os.time()
end

function end_area()
  time_duration = os.time() - time_start_area
  line = ' @Co-}@Y'..env_area:upper()..'@C{-o  @GFINISHED: '..SecondsToClock(time_duration)
  reportout(line)
  env_bosscount = false
end

-----------------
-- Zone awareness
-----------------
function OnPluginBroadcast(msg, id, name, text)
  if text == 'char.base' then
    Send_GMCP_Packet('request area')
    Send_GMCP_Packet('request room')
    debugout('We have reconnected, issue area/room request')
  end
  if env_active then
    -- if name ~= 'Aardwolf_Soundpack' and name ~= 'Galabans_Moons' and name ~= 'Aardwolf_GMCP_Mapper' and name ~= 'WinkleGold_Search_Destroy' and name ~= 'WinkleGold_Mapper_Extender' then
    --   debugout('msg: '..msg..', id: '..id..', name: '..name..', text: '..text) -- Ignore known broadcasts, give unknown ones
    -- end
    debugout(name..': '..text)
    if name == 'GMCP_handler' then
      -- Figuring out what gmcp contains for char.* and for room.*
      -- if string.match(text,'char.') then
      --   debugout(text..' received! This is what we have about it:')
      --   debugout(dump(gmcp(text)))
      -- elseif string.match(text,'room.') then
      --   debugout(text..' received! This is what we have about it:')
      --   debugout(dump(gmcp(text)))
      -- end
      if text == 'room.area' then
        debugout('room.area broadcast heard.')
        if gmcp('room.area.id') == 'titan' then
          if env_area ~= 'titan' then
            if env_area == 'terra' then
              noteout(' @Co-}@Y'..string.upper(env_area)..'@C{-o @Warea left.')
              EnableTriggerGroup('me_terra', false)
              debugout('me_terra trigger group OFF.')
              EnableTriggerGroup('me_bhits', false)
              debugout('me_bhits trigger group OFF.')
            end
            env_area = 'titan'
            EnableTriggerGroup('me_titan', true)
            debugout('me_titan trigger group ON.')
            EnableTriggerGroup('me_bhits', true)
            debugout('me_bhits trigger group ON.')
            SaveState()
            noteout(' @Co-}@Y'..string.upper(env_area)..'@C{-o @Warea entered. Triggers are [@GON@W]')
          end
        elseif gmcp('room.area.id') == 'terra' then
          if env_area ~= 'terra' then
            if env_area == 'titan' then
              noteout(' @Co-}@Y'..string.upper(env_area)..'@C{-o @Warea left.')
              EnableTriggerGroup('me_titan', false)
              debugout('me_titan trigger group OFF.')
              EnableTriggerGroup('me_bhits', false)
              debugout('me_bhits trigger group OFF.')
            end
            env_area = 'terra'
            EnableTriggerGroup('me_terra', true)
            debugout('me_terra trigger group ON.')
            EnableTriggerGroup('me_bhits', true)
            debugout('me_bhits trigger group ON.')
          SaveState()
            noteout(' @Co-}@Y'..string.upper(env_area)..'@C{-o @Warea entered. Triggers are [@GON@W]')
          end
        else
          if env_area == 'titan' or env_area == 'terra' then
            noteout(' @Co-}@Y'..string.upper(env_area)..'@C{-o @Warea left.')
            env_area = 'out'
            EnableTriggerGroup('me_titan', false)
            debugout('me_titan trigger group OFF.')
            EnableTriggerGroup('me_terra', false)
            debugout('me_terra trigger group OFF.')
            EnableTriggerGroup('me_bhits', false)
            debugout('me_bhits trigger group OFF.')
            SaveState()
          end
        end
      end
    end
  end
end

-------------------
-- Helpers - output
-------------------
function miniepics_help()
  AnsiNote(ColoursToANSI('@C{-o @Y----------------@C[  ')..logo..ColoursToANSI('  @C]@Y---------------- @Co-}@w'))
  AnsiNote()
  AnsiNote(ColoursToANSI('  @CCommands:'))
  if env_active then
    AnsiNote(ColoursToANSI('    @Yminiepics         @w- switch plugin ON / OFF       Now: [@G ON @w]'))
  else
    AnsiNote(ColoursToANSI('    @Yminiepics         @w- switch plugin ON / OFF       Now: [@R OFF @w]'))
  end
  if env_commlog then
    AnsiNote(ColoursToANSI('    @Yminiepics commlog @w- redirect echo to commlog     Now: [@G ON @w]'))
  else
    AnsiNote(ColoursToANSI('    @Yminiepics commlog @w- redirect echo to commlog     Now: [@R OFF @w]'))
  end
  AnsiNote(ColoursToANSI('    @Yminiepics help    @w- this screen'))
  if env_commlog then
    AnsiNote(ColoursToANSI('    @Yminiepics gt      @w- set output channel to group tell & commlog'))
    AnsiNote(ColoursToANSI('    @Yminiepics say     @w- set output channel to say & commlog'))
    AnsiNote(ColoursToANSI('    @Yminiepics echo    @w- set output channel to local echo & commlog'))
  else
    AnsiNote(ColoursToANSI('    @Yminiepics gt      @w- set output channel to group tell'))
    AnsiNote(ColoursToANSI('    @Yminiepics say     @w- set output channel to say'))
    AnsiNote(ColoursToANSI('    @Yminiepics echo    @w- set output channel to local echo'))
  end
  -- AnsiNote(ColoursToANSI('    @Yminiepics debug   @w- toggle debug info'))
  AnsiNote()
  AnsiNote(ColoursToANSI('  @CUsage:'))
  AnsiNote(ColoursToANSI('    @wPlugin will autodetect your current zone and activate'))
  AnsiNote(ColoursToANSI('    @wrequired triggers that report to [@Y '..env_chan..' @w] channel.'))
  AnsiNote(ColoursToANSI('    @wKeep in mind that echo & commlog are instant, while say & gt'))
  AnsiNote(ColoursToANSI('    @ware prone to lag (especially if you spam commands).'))
  AnsiNote()
  AnsiNote(ColoursToANSI('@C{-o @Y---------------------------------------------------------------- @Co-}@w'))
end

function miniepics_explain()
  if env_boss and env_active then
    reportout(' @W'..bossinfo[env_boss].long)
  end
end

function debugout(e)
  if env_debug then
    AnsiNote(logo..ColoursToANSI(' @Y[@ydebug@Y] @W'..e))
  end
end

function noteout(e)
  if env_commlog then 
    CallPlugin("b555825a4a5700c35fa80780", "storeFromOutside", AnsiToColours(logoshort)..e, 1, true)
  else
    AnsiNote(logoshort..ColoursToANSI(e))
  end
end

function reportout(e)
  if env_commlog then CallPlugin("b555825a4a5700c35fa80780", "storeFromOutside", AnsiToColours(logoshort)..e, 1, true) end
  if env_chan == 'echo' then AnsiNote(logoshort..ColoursToANSI(e)) end
  if env_chan == 'gt' then SendNoEcho('gt'..e..'@Y') end
  if env_chan == 'say' then SendNoEcho('say'..e..'@C') end
end

function OnPluginInstall()
  AnsiNote(logo..ColoursToANSI('@w type @Yminiepics help @wfor commands and usage info.'))
end

function OnPluginSaveState()
  -- this will run when SaveState() is called or if mush is closing etc
  SetVariable('env_area', env_area)
  SetVariable('env_chan', env_chan)
  SetVariable('env_active', sb(env_active))
  SetVariable('env_debug', sb(env_debug))
  SetVariable('env_commlog', sb(env_commlog))
end


]]>
</script> 

</muclient>
