<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<muclient>
<plugin
   name="HooK_MiniEpics"
   author="BlueFeather"
   id="2a0221da142c2505699c5adb"
   language="Lua"
   purpose="Mini epic (Titan/Terra) triggers and reports"
   save_state="y"
   date_written="2019-06-26 21:47:01"
   requires="5.06"
   version="1.0"
   >
<description trim="y">
<![CDATA[
A collection of triggers for use in Titan and Terra miniepics - to make life there easier.
]]>
</description>

</plugin>


<!--  Get our standard constants -->

<include name="constants.lua"/>

<!--  Triggers  -->

<triggers>
  <trigger match="* grabs a nearby shield to defend himself!"                       enabled="y" keep_evaluating="y" sequence="99"><send>echo shield up!</send></trigger>
  <trigger match="* wears a Mighty Shield as a shield."                             enabled="y" keep_evaluating="y" sequence="99"><send>echo shield up!</send></trigger>
  <trigger match="With awesome force * cleaves *'s shield in half!"                 enabled="y" keep_evaluating="y" sequence="99"><send>echo shield down!</send></trigger>
  <trigger match="* quaffs a potion of Sanctuary."                                  enabled="y" keep_evaluating="y" sequence="99"><send>echo sanc up!</send></trigger>
  <trigger match="* is surrounded by a shimmering white aura of divine protection." enabled="y" keep_evaluating="y" sequence="99"><send>echo sanc up!</send></trigger>
  <trigger match="The white aura around *'s body vanishes."                         enabled="y" keep_evaluating="y" sequence="99"><send>echo dispel!</send></trigger>
</triggers>

<!--  Plugin help  -->

<aliases>
  <alias script="toggle_debug" match="miniepics_debug" enabled="y"></alias>
</aliases>

<script>
<![CDATA[
-----------------
-- Default values
-----------------
require "gmcphelper"
env_active = false

-----------------
-- Zone awareness
-----------------
function OnPluginBroadcast(msg, id, name, text)
  if text == 'char.base' then
    Send_GMCP_Packet('request area')
    Send_GMCP_Packet('request room')
    Note('We have reconnected, issue area/room request')
  end
  if env_active then
    if name ~= 'Aardwolf_Soundpack' and name ~= 'Galabans_Moons' and name ~= 'Aardwolf_GMCP_Mapper' and name ~= 'WinkleGold_Search_Destroy' and name ~= 'WinkleGold_Mapper_Extender' then
      Note('msg: '..msg..', id: '..id..', name: '..name..', text: '..text) -- Ignore known broadcasts, give unknown ones
    end
    if name == 'GMCP_handler' then
      -- if string.match(text,'char.') then
      --   Note(text..' received! This is what we have about it:')
      --   Note(dump(gmcp(text)))
      -- elseif string.match(text,'room.') then
      --   Note(text..' received! This is what we have about it:')
      --   Note(dump(gmcp(text)))
      -- end
      if text == 'room.area' then
        if gmcp('room.area.id') == 'titan' then
          Note('We have entered titan area')
        elseif gmcp('room.area.id') == 'terra' then
          Note('We have entered terra area')
        else
          Note('We have exited titan/terra area')
        end
      end
    end
  end
end

function toggle_debug()
  if env_active then
    env_active = false
    Note('MiniEpics debug: [OFF]')
  else
    env_active = true
    Note('MiniEpics debug: [ON]')
  end
end

function dump(o)
  if type(o) == 'table' then
     local s = '{ '
     for k,v in pairs(o) do
        if type(k) ~= 'number' then k = '"'..k..'"' end
        s = s .. '['..k..'] = ' .. dump(v) .. ','
     end
     return s .. '} '
  else
     return tostring(o)
  end
end

]]>
</script> 

</muclient>
